import numpy
from pyscf import lib
from cqcpy import cc_equations

einsum = lib.einsum
#einsum = einsum

def _T1_S1(T1, g, S1old):
    T1 += einsum('Iai,I->ai', g.vo, S1old)

def _T1_U11(T1, g, G, U11old):
    T1 += einsum('I,Iai->ai',G, U11old)
    T1 += einsum('Iab,Ibi->ai',g.vv, U11old)
    T1 -= einsum('Iji,Iaj->ai',g.oo, U11old)

def _T1_T1S1(T1, g, T1old, S1old):
    T1 += einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 -= einsum('Iji,aj,I->ai', g.oo, T1old, S1old)

def _T1_T2S1(T1, g, T2old, S1old):
    T1 += einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)

def _T1_T1U11(T1, g, T1old, U11old):
    T1 += einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 -= einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 -= einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)

def _T1_T1T1S1(T1, g, T1old, S1old):
    T1 -= einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

def _T2_U11(T2, g, U11old):
    T2 += einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 -= einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 -= einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += einsum('Ibj,Iai->abij', g.vo, U11old)

def _T2_T2S1(T2, g, T2old, S1old):
    T2 += einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 -= einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)

    T2 -= einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)

def _T2_T1U11(T2, g, T1old, U11old):
    T2 += einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 -= einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 -= einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)

    T2 -= einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 -= einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)

def _T2_T2U11(T2, g, T2old, U11old):
    T2 += einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 -= einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 -= einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)

    T2 -= einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)

    T2 -= einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)

def _T2_T1T2S1(T2, g, T1old, T2old, S1old):
    T2 -= einsum('Ikc,acij,bk,I->abij', g.ov, T2old, T1old, S1old)
    T2 += einsum('Ikc,bcij,ak,I->abij', g.ov, T2old, T1old, S1old)

    T2 -= einsum('Ikc,abik,cj,I->abij', g.ov, T2old, T1old, S1old)
    T2 += einsum('Ikc,abjk,ci,I->abij', g.ov, T2old, T1old, S1old)

def _T2_T1T1U11(T2, g, T1old, U11old):
    T2 -= einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += einsum('Ikc,cj,ak,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 -= einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)

def _S1_all(S1, g, h, f, I, S1old, T1old, U11old):
    S1 += einsum('Iia,ai->I', h.ov, T1old)
    S1 += einsum('ia,Iai->I', f.ov, U11old)
    S1 += einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += einsum('ijab,ai,Ibj->I', I.oovv, T1old, U11old)

def _U11_T1(U11, h, T1old):
    U11 += einsum('Iab,bi->Iai', h.vv, T1old)
    U11 -= einsum('Iji,aj->Iai', h.oo, T1old)

def _U11_T2(U11, h, T2old):
    U11 += einsum('Ijb,abij->Iai', h.ov, T2old)

def _U11_U11(U11, F, I, U11old):
    U11 += einsum('ab,Ibi->Iai', F.vv, U11old)
    U11 -= einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 -= einsum('ajbi,Ibj->Iai', I.vovo, U11old)

def _U11_T1T1(U11, h, I, T1old):
    U11 -= einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)

def _U11_T1U11(U11, f, I, T1old, U11old):
    U11 -= einsum('jb,bi,Iaj->Iai', f.ov, T1old, U11old)
    U11 -= einsum('jb,aj,Ibi->Iai', f.ov, T1old, U11old)
    U11 += einsum('ajcb,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 -= einsum('kjib,ak,Ibj->Iai', I.ooov, T1old, U11old)
    U11 -= einsum('ajbc,bj,Ici->Iai', I.vovv, T1old, U11old)
    U11 += einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)

def _U11_T2U11(U11, I, T2old, U11old):
    U11 -= 0.5*einsum('jkbc,bcji,Iak->Iai', I.oovv, T2old, U11old)
    U11 -= 0.5*einsum('jkbc,bajk,Ici->Iai', I.oovv, T2old, U11old)
    U11 += einsum('jkbc,abij,Ick->Iai', I.oovv, T2old, U11old)

def _U11_S1U11(U11, g, S1old, U11old):
    U11 += einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 -= einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)

def _U11_U11U11(U11, g, U11old):
    U11 += einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 -= einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 -= einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)

def _U11_T1T1U11(U11, I, T1old, U11old):
    U11 -= einsum('jkcd,ci,aj,Idk->Iai', I.oovv, T1old, T1old, U11old)
    U11 -= einsum('jkcd,cj,di,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 -= einsum('jkcd,cj,ak,Idi->Iai', I.oovv, T1old, T1old, U11old)

def _U11_S1T1U11(U11, g, S1old, T1old, U11old):
    U11 -= einsum('Jjb,J,aj,Ibi->Iai', g.ov, S1old, T1old, U11old)
    U11 -= einsum('Jjb,J,bi,Iaj->Iai', g.ov, S1old, T1old, U11old)

def epcc_simple(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # F1
    _T1_S1(T1, g, S1old)
    _T1_U11(T1, g, G, U11old)
    _T1_T1S1(T1, g, T1old, S1old)
    _T1_T2S1(T1, g, T2old, S1old)
    _T1_T1U11(T1, g, T1old, U11old)
    _T1_T1T1S1(T1, g, T1old, S1old)

    # F2
    _T2_U11(T2, g, U11old)
    _T2_T2S1(T2, g, T2old, S1old)
    _T2_T1U11(T2, g, T1old, U11old)
    _T2_T2U11(T2, g, T2old, U11old)
    _T2_T1T2S1(T2, g, T1old, T2old, S1old)
    _T2_T1T1U11(T2, g, T1old, U11old)

    # S1 equation
    S1 = H.copy()
    _S1_all(S1, g, h, F, I, S1old, T1old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    _U11_T1(U11, h, T1old)
    _U11_T2(U11, h, T2old)
    _U11_U11(U11, F, I, U11old)
    _U11_T1T1(U11, h, I, T1old)
    _U11_T1U11(U11, F, I, T1old, U11old)
    _U11_T2U11(U11, I, T2old, U11old)
    _U11_S1U11(U11, g, S1old, U11old)
    _U11_U11U11(U11, g, U11old)
    _U11_T1T1U11(U11, I, T1old, U11old)
    _U11_S1T1U11(U11, g, S1old, T1old, U11old)

    return T1,T2,S1,U11

def epcc_opt(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    T1 = F.vo.copy()
    T1 += einsum('xai,x->ai', g.vo, S1old)
    T1 += einsum('x,xai->ai',G, U11old)

    T2 = I.vvoo.copy()
    abij_temp = einsum('xai,xbj->abij', g.vo, U11old)
    T2 += abij_temp
    T2 -= abij_temp.transpose((1,0,2,3))
    T2 -= abij_temp.transpose((0,1,3,2))
    T2 += abij_temp.transpose((1,0,3,2))
    abij_temp = None

    T2A = T2old.copy()
    T2A += 0.5*einsum('ai,bj->abij',T1old,T1old)
    T2A -= 0.5*einsum('bi,aj->abij',T1old,T1old)

    Fvv = F.vv.copy()
    Fvv += einsum('xab,x->ab', g.vv, S1old)
    Fvv -= 0.5*einsum('jb,aj->ab',F.ov,T1old)
    Fvv -= einsum('ajcb,cj->ab',I.vovv,T1old)
    Fvv -= 0.5*einsum('jkbc,acjk->ab',I.oovv,T2A)
    Fvv -= einsum('yjb,yaj->ab', g.ov, U11old)

    Foo = F.oo.copy()
    Foo += einsum('xji,x->ji', g.oo, S1old)
    Foo += 0.5*einsum('jb,bi->ji',F.ov,T1old)
    Foo += einsum('jkib,bk->ji',I.ooov,T1old)
    Foo += 0.5*einsum('jkbc,bcik->ji',I.oovv,T2A)
    Foo += einsum('yjb,ybi->ji', g.ov, U11old)
    T2A = None

    gsov = einsum('yia,y->ia', g.ov, S1old)
    gtm = einsum('xjb,bj->x', g.ov, T1old)
    Fov = F.ov.copy()
    Fov += einsum('jkbc,ck->jb',I.oovv,T1old)
    Fov += gsov

    T1 += einsum('ab,bi->ai',Fvv,T1old)
    T1 -= einsum('ji,aj->ai',Foo,T1old)
    T1 += einsum('jb,abij->ai',Fov,T2old)
    T1 -= einsum('ajbi,bj->ai',I.vovo,T1old)
    T1 += 0.5*einsum('ajbc,bcij->ai',I.vovv,T2old)
    T1 -= 0.5*einsum('jkib,abjk->ai',I.ooov,T2old)

    T2B = T2old.copy()
    T2B += einsum('ai,bj->abij',T1old,T1old)
    T2B -= einsum('bi,aj->abij',T1old,T1old)

    Woooo = I.oooo.copy()
    Woooo += einsum('klic,cj->klij',I.ooov,T1old)
    Woooo -= einsum('kljc,ci->klij',I.ooov,T1old)
    Woooo += 0.25*einsum('klcd,cdij->klij',I.oovv,T2B)
    T2 += 0.5*einsum('klij,abkl->abij',Woooo,T2B)
    Woooo = None

    Wvvvv = I.vvvv.copy()
    Wvvvv -= einsum('akcd,bk->abcd',I.vovv,T1old)
    Wvvvv += einsum('bkcd,ak->abcd',I.vovv,T1old)
    Wvvvv += 0.25*einsum('klcd,abkl->abcd',I.oovv,T2B)
    T2 += 0.5*einsum('abcd,cdij->abij',Wvvvv,T2B)
    T2B = None
    Wvvvv = None

    Wovvo = -I.vovo.transpose((1,0,2,3))
    Wovvo -= einsum('bkcd,dj->kbcj',I.vovv,T1old)
    Wovvo += einsum('kljc,bl->kbcj',I.ooov,T1old)
    temp = 0.5*T2old + einsum('dj,bl->dbjl',T1old,T1old)
    Wovvo -= einsum('klcd,dbjl->kbcj',I.oovv,temp)
    temp = einsum('kbcj,acik->abij',Wovvo,T2old)
    temp += einsum('bkcj,ci,ak->abij',I.vovo,T1old,T1old)
    T2 += temp
    T2 -= temp.transpose((0,1,3,2))
    T2 -= temp.transpose((1,0,2,3))
    T2 += temp.transpose((1,0,3,2))
    temp = None
    #Wovvo = None

    Ftemp = Fvv - 0.5*einsum('jb,aj->ab',Fov,T1old)
    temp_ab = einsum('bc,acij->abij',Ftemp,T2old)
    temp_ab += einsum('bkij,ak->abij',I.vooo,T1old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    Ftemp = Foo + 0.5*einsum('jb,bi->ji',Fov,T1old)
    temp_ij = -einsum('kj,abik->abij',Ftemp,T2old)
    temp_ij += einsum('abcj,ci->abij',I.vvvo,T1old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # remaining T1 terms
    T1 += einsum('xab,xbi->ai', g.vv, U11old)
    T1 -= einsum('xji,xaj->ai',g.oo, U11old)

    T1 += einsum('x,xai->ai', gtm, U11old)
    ttt = einsum('jb,bi->ji', gsov, T1old)
    T1 -= einsum('ji,aj->ai', ttt, T1old)

    # Remaining T2 terms
    gtov = einsum('xac,ci->xai', g.vv, T1old)
    gtov -= einsum('xki,ak->xai', g.oo, T1old)
    temp_abij = einsum('xai,xbj->abij', gtov, U11old)
    T2temp = T2old - einsum('bi,aj->abij', T1old, T1old)
    Wmvo = einsum('xkc,acik->xai', g.ov, T2temp)
    temp_abij += einsum('xai,xbj->abij', Wmvo, U11old)
    T2 += temp_abij
    T2 -= temp_abij.transpose((1,0,2,3))
    T2 -= temp_abij.transpose((0,1,3,2))
    T2 += temp_abij.transpose((1,0,3,2))
    temp_abij = None

    gstv = einsum('kc,bk->bc', gsov, T1old)
    temp_ab = -0.5*einsum('bc,acij->abij', gstv, T2old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    gsto = einsum('kc,cj->kj', gsov, T1old)
    temp_ij = -0.5*einsum('kj,abik->abij', gsto, T2old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # S1 and U11 terms
    S1 = H.copy()
    U11 = h.vo.copy()
    S1 += einsum('xia,ai->x', h.ov, T1old)
    S1 += einsum('ia,xai->x', F.ov, U11old)
    S1 += einsum('ia,xai->x', gsov, U11old)

    Xov = einsum('ijab,xbj->xia', I.oovv, U11old)
    S1 += einsum('xia,ai->x', Xov, T1old)

    U11 += 0.5*einsum('xjb,abij->xai', Xov, T2old)

    U11 += einsum('xab,bi->xai', h.vv, T1old)
    U11 -= einsum('xji,aj->xai', h.oo, T1old)

    U11 += einsum('xjb,abij->xai', h.ov, T2temp)

    U11 += einsum('ab,xbi->xai', Fvv, U11old)
    U11 -= einsum('ji,xaj->xai', Foo, U11old)

    U11 += einsum('jabi,xbj->xai', Wovvo, U11old)

    Xvv = einsum('jb,aj->ab', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ab,xbi->xai', Xvv, U11old)

    Xoo = einsum('jb,bi->ji', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ji,xaj->xai', Xoo, U11old)

    Xmm = einsum('yjb,xbj->xy', g.ov, U11old)
    U11 += einsum('xy,yai->xai', Xmm, U11old)

    #S1 += 1.0*einsum('I,I->I', w, S1old)
    #U11 += 1.0*einsum('I,Iai->Iai', w, U11old)

    return T1,T2,S1,U11


def qed_ccsd_sn_u1n_opt(F, I, w, g, h, G, H, nfock1, nfock2, amps):
    '''
    nfock1 -- order of Sn operator
    nfock2 -- order of U1n operator
    '''
    T1old, T2old, Snold, U1nold = amps
    Sn = [None]*nfock1
    U1n = [None]*nfock2

    #epcc_opt is QED-CCSD_S1_U11,
    #T1, T2, Sn[0], U1n[0] = epcc_opt(F, I, w, g, h, G, H, T1old, T2old, Snold[0], U1nold[0])

    S1old = Snold[0]
    U11old = U1nold[0]

    #-------------------------------------------------------------------------
    # copy of  ccsd_opt (since some intermediate avaiable will be used later)
    # CCSD equations
    T1 = F.vo.copy()
    T1 += einsum('xai,x->ai', g.vo, S1old)
    T1 += einsum('x,xai->ai',G, U11old)

    T2 = I.vvoo.copy()
    abij_temp = einsum('xai,xbj->abij', g.vo, U11old)
    T2 += abij_temp
    T2 -= abij_temp.transpose((1,0,2,3))
    T2 -= abij_temp.transpose((0,1,3,2))
    T2 += abij_temp.transpose((1,0,3,2))
    abij_temp = None

    T2A = T2old.copy()
    T1T1 = einsum('ai,bj->abij',T1old, T1old)

    T2A += 0.5*T1T1 #einsum('ai,bj->abij',T1old, T1old)
    T2A -= 0.5*einsum('bi,aj->abij',T1old, T1old)

    Fvv = F.vv.copy()
    Fvv += einsum('xab,x->ab', g.vv, S1old)
    Fvv -= 0.5*einsum('jb,aj->ab',F.ov,T1old)
    Fvv -= einsum('ajcb,cj->ab',I.vovv,T1old)
    Fvv -= 0.5*einsum('jkbc,acjk->ab',I.oovv,T2A)
    Fvv -= einsum('yjb,yaj->ab', g.ov, U11old)

    Foo = F.oo.copy()
    Foo += einsum('xji,x->ji', g.oo, S1old)
    Foo += 0.5*einsum('jb,bi->ji',F.ov,T1old)
    Foo += einsum('jkib,bk->ji',I.ooov,T1old)
    Foo += 0.5*einsum('jkbc,bcik->ji',I.oovv,T2A)
    Foo += einsum('yjb,ybi->ji', g.ov, U11old)
    T2A = None

    gsov = einsum('yia,y->ia', g.ov, S1old)
    gtm = einsum('xjb,bj->x', g.ov, T1old)
    Fov = F.ov.copy()
    Fov += einsum('jkbc,ck->jb',I.oovv,T1old)
    Fov += gsov

    T1 += einsum('ab,bi->ai',Fvv,T1old)
    T1 -= einsum('ji,aj->ai',Foo,T1old)
    T1 += einsum('jb,abij->ai',Fov,T2old)
    T1 -= einsum('ajbi,bj->ai',I.vovo,T1old)
    T1 += 0.5*einsum('ajbc,bcij->ai',I.vovv,T2old)
    T1 -= 0.5*einsum('jkib,abjk->ai',I.ooov,T2old)

    T2B = T2old.copy()
    T2B += einsum('ai,bj->abij',T1old, T1old)
    T2B -= einsum('bi,aj->abij',T1old, T1old)

    Woooo = I.oooo.copy()
    Woooo += einsum('klic,cj->klij',I.ooov,T1old)
    Woooo -= einsum('kljc,ci->klij',I.ooov,T1old)
    Woooo += 0.25*einsum('klcd,cdij->klij',I.oovv,T2B)
    T2 += 0.5*einsum('klij,abkl->abij',Woooo,T2B)
    Woooo = None

    Wvvvv = I.vvvv.copy()
    Wvvvv -= einsum('akcd,bk->abcd',I.vovv,T1old)
    Wvvvv += einsum('bkcd,ak->abcd',I.vovv,T1old)
    Wvvvv += 0.25*einsum('klcd,abkl->abcd',I.oovv,T2B)
    T2 += 0.5*einsum('abcd,cdij->abij',Wvvvv,T2B)
    T2B = None
    Wvvvv = None

    Wovvo = -I.vovo.transpose((1,0,2,3))
    Wovvo -= einsum('bkcd,dj->kbcj',I.vovv,T1old)
    Wovvo += einsum('kljc,bl->kbcj',I.ooov,T1old)
    temp = 0.5*T2old + einsum('dj,bl->dbjl',T1old, T1old)
    Wovvo -= einsum('klcd,dbjl->kbcj',I.oovv,temp)
    temp = einsum('kbcj,acik->abij',Wovvo,T2old)
    temp += einsum('bkcj,ci,ak->abij',I.vovo,T1old, T1old)
    T2 += temp
    T2 -= temp.transpose((0,1,3,2))
    T2 -= temp.transpose((1,0,2,3))
    T2 += temp.transpose((1,0,3,2))
    temp = None
    #Wovvo = None

    Ftemp = Fvv - 0.5*einsum('jb,aj->ab',Fov,T1old)
    temp_ab = einsum('bc,acij->abij',Ftemp,T2old)
    temp_ab += einsum('bkij,ak->abij',I.vooo,T1old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    Ftemp = Foo + 0.5*einsum('jb,bi->ji',Fov,T1old)
    temp_ij = -einsum('kj,abik->abij',Ftemp,T2old)
    temp_ij += einsum('abcj,ci->abij',I.vvvo,T1old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # remaining T1 terms
    T1 += einsum('xab,xbi->ai', g.vv, U11old)
    T1 -= einsum('xji,xaj->ai',g.oo, U11old)

    T1 += einsum('x,xai->ai', gtm, U11old)
    ttt = einsum('jb,bi->ji', gsov, T1old)
    T1 -= einsum('ji,aj->ai', ttt, T1old)

    # Remaining T2 terms
    gtov = einsum('xac,ci->xai', g.vv, T1old)
    gtov -= einsum('xki,ak->xai', g.oo, T1old)
    temp_abij = einsum('xai,xbj->abij', gtov, U11old)
    T2temp = T2old - einsum('bi,aj->abij', T1old, T1old)
    Wmvo = einsum('xkc,acik->xai', g.ov, T2temp)
    temp_abij += einsum('xai,xbj->abij', Wmvo, U11old)
    T2 += temp_abij
    T2 -= temp_abij.transpose((1,0,2,3))
    T2 -= temp_abij.transpose((0,1,3,2))
    T2 += temp_abij.transpose((1,0,3,2))
    temp_abij = None

    gstv = einsum('kc,bk->bc', gsov, T1old)
    temp_ab = -0.5*einsum('bc,acij->abij', gstv, T2old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    gsto = einsum('kc,cj->kj', gsov, T1old)
    temp_ij = -0.5*einsum('kj,abik->abij', gsto, T2old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # S1 and U11 terms
    S1 = H.copy()
    U11 = h.vo.copy()
    S1 += einsum('xia,ai->x', h.ov, T1old)
    S1 += einsum('ia,xai->x', F.ov, U11old)
    S1 += einsum('ia,xai->x', gsov, U11old)

    Xov = einsum('ijab,xbj->xia', I.oovv, U11old)
    S1 += einsum('xia,ai->x', Xov, T1old)

    U11 += 0.5*einsum('xjb,abij->xai', Xov, T2old)

    U11 += einsum('xab,bi->xai', h.vv, T1old)
    U11 -= einsum('xji,aj->xai', h.oo, T1old)

    U11 += einsum('xjb,abij->xai', h.ov, T2temp)

    U11 += einsum('ab,xbi->xai', Fvv, U11old)
    U11 -= einsum('ji,xaj->xai', Foo, U11old)

    U11 += einsum('jabi,xbj->xai', Wovvo, U11old)

    Xvv = einsum('jb,aj->ab', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ab,xbi->xai', Xvv, U11old)

    Xoo = einsum('jb,bi->ji', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ji,xaj->xai', Xoo, U11old)

    Xmm = einsum('yjb,xbj->xy', g.ov, U11old)
    U11 += einsum('xy,yai->xai', Xmm, U11old)

    #S1 += 1.0*einsum('I,I->I', w, S1old)
    #U11 += 1.0*einsum('I,Iai->Iai', w, U11old)

    # end of copy 
    #-------------------------------------------------------------------------
    
    np = w.shape[0]
    w2d = numpy.zeros((np,np))
    for k in range(np):
        w2d[k,k] = w[k]

    Sn[0] = S1
    U1n[0] = U11

    Xmm = einsum('Iia,Jai->IJ', g.ov, U1nold[0])
    govT1 = einsum('Mia,ai->M', g.ov, T1old)

    # order of bare photonic excitation (Sn)
    # here, we only need to add the difference (compared to epcc_opt)
    if nfock1 > 1:
        # add nfock == 2 term

        S2old = Snold[1]
        # S1
        Sn[0] += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
        
        # S2
        Sn[1] = numpy.zeros((w.shape[0],w.shape[0]))
        S2 = Sn[1]
        
        S2 += 1.0*einsum('IK,JK->IJ', w2d, S2old)
        S2 += 1.0*einsum('JK,IK->IJ', w2d, S2old)

        S2 += Xmm
        S2 += Xmm.T
        S2 += 1.0*einsum('KJ,IK->IJ', Xmm, S2old)
        S2 += 1.0*einsum('KI,JK->IJ', Xmm, S2old)
        S2 -= 1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

        # U11
        g2vo = 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
        g2ov = 1.0*einsum('Jjb,IJ->Ijb', g.ov, S2old)
       
        # the 0.5 and 0.3333 coefficients to be double checked!!!!
        temp = 0.5*T2old + 0.3333333333333333*T1T1.transpose((1,0,2,3))
        #temp = T2old + T1T1.transpose((1,0,2,3))

        U1n[0] += g2vo
        #U1n[0] += 1.0*einsum('Jai,IJ->Iai', gtov, S2old)
        U1n[0] += 0.5*einsum('Jai,IJ->Iai', gtov, S2old)
        U1n[0] -= 1.0*einsum('Ijb,abji->Iai',  g2ov, temp)

    if nfock1 > 2:
        # add nfock == 3 term (difference from nfock == 2, no double counting terms)
        Sn[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0]))
        S3 = Sn[2]
        S3old = Snold[2]

        S2 += 0.3333333333333333*einsum('K,IJK->IJ', govT1, S3old)
        S2 += 0.3333333333333333*einsum('K,IKJ->IJ', govT1, S3old)
        S2 += 0.1666666666666666*einsum('K,JKI->IJ', govT1, S3old)
        S2 += 0.1666666666666666*einsum('K,KJI->IJ', govT1, S3old)
       
        S3 += 0.3333333333333333*einsum('IL,JKL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('IL,JLK->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('IL,KLJ->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('IL,LKJ->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('JL,IKL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('JL,ILK->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('JL,KLI->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('JL,LKI->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('KL,IJL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('KL,ILJ->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('KL,JLI->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('KL,LJI->IJK', w2d, S3old)

        S3 += 0.3333333333333333*einsum('LK,IJL->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LJ,IKL->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LK,ILJ->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LJ,ILK->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LI,JKL->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LK,JLI->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LI,JLK->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LJ,KLI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LI,KLJ->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LK,LJI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LJ,LKI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LI,LKJ->IJK', Xmm, S3old)

    if nfock1 > 3:
        # add nfock == 4 term
        Sn[3] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S4 = Sn[3]
        S4old = Snold[3]

        S3 += 0.08333333333333333*einsum('L,IJKL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IJLK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IKJL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IKLJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,ILJK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,ILKJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,JKIL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,JLIK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,KJIL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,KLIJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,LJIK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,LKIJ->IJK', govT1, S4old)
        
        S4 += 0.08333333333333333*einsum('IM,JKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KLJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MKJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MLJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MKIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MLIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMLJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MJIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MLIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMKJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MJIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MKIJ->IJKL', w2d, S4old)

        S4 += 0.08333333333333333*einsum('ML,IJKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IJLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IJMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IJML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IKJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IKLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IKMJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IKML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,ILJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,ILKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,ILMJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,ILMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IMJK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IMJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IMKJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IMKL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IMLJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IMLK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,JKIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JKLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JKML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,JLIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JLKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JLMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,JMIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,JMIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JMKL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JMLK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,KJIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,KLIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,KLJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,KMIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,KMIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,KMJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,LJIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,LKIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,LKJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,LMIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,LMIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,LMJK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,MJIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,MJIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,MKIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,MKIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,MKJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,MLIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,MLIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,MLJK->IJKL', Xmm, S4old)
 
    if nfock1 > 4:
        # add nfock == 5 term
        Sn[4] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S5 = Sn[4]
        S5old = Snold[4]

        S4 += 0.016666666666666666*einsum('M,IJKLM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJKML->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJLKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJLMK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJMKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJMLK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKJLM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKJML->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKLJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKLMJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKMJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKMLJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILJKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILJMK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILKJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILKMJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILMJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILMKJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMJKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMJLK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMKJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMKLJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMLJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMLKJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JKILM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JKIML->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JKLMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JKMLI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JLIKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JLIMK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JLKMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JLMKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JMIKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JMILK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JMKLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JMLKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KJILM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KJIML->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KJLMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KJMLI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KLIJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KLIMJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KLJMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KLMJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KMIJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KMILJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KMJLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KMLJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LJIKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LJIMK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LJKMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LJMKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LKIJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LKIMJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LKJMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LKMJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LMIJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LMIKJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LMJKI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LMKJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MJIKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MJILK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MJKLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MJLKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MKIJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MKILJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MKJLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MKLJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MLIJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MLIKJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MLJKI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MLKJI->IJKL', govT1, S5old)
        
        Xw = Xmm 

        S5 += 0.016666666666666666*einsum('IN,JKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLKJI->IJKLM', w2d, S5old)

        S5 += 0.016666666666666666*einsum('NM,IJKLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJKMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJLKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJLMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJLNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJMKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJMLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJMNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJMNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJNKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJNKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJNLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKJLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKJMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKJNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKJNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKLJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKLMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKLNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKMJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKMLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKMNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKMNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKNJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKNJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKNLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILJKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILJMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILJNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILJNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILKJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILKMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILKNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILMJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILMKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILMNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILMNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILNJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILNJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILNKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMJKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMJLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMJNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMJNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMKJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMKLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMKNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMLJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMLKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMLNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMLNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMNJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMNJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMNKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INJKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INJKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INJLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INJLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INJMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INJML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INKJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INKJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INKLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INKLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INKMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INKML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INLJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INLJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INLKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INLKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INLMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INLMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INMJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INMJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INMKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INMLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JKILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JKIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JKINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JKINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKLMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JKLNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKMLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JKMNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKMNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JKNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKNLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JKNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JLIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JLIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JLINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JLINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLKMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JLKNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLMKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JLMNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLMNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JLNKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLNKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JLNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JMIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JMILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JMINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JMINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMKLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JMKNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMLKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JMLNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMLNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JMNKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMNKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JMNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JNIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JNIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JNILK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JNILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JNIMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JNIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JNKLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNKLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JNKMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNKML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JNLKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNLKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JNLMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNLMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JNMKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNMKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JNMLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNMLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KJILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KJIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KJINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KJINM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KJLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KJMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KJNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KJNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KLIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KLIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KLINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KLINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KLJMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KLJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KLJNM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KLMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KLMNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KLNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KLNMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KLNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KMIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KMILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KMINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KMINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KMJLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KMJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KMJNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KMLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KMLNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KMNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KMNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KMNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KNIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KNIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KNILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KNILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KNIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KNIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KNJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KNJLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KNJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KNJML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KNLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KNLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KNLMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KNMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KNMLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KNMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LJIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LJIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LJINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LJINM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LJKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LJMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LJNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LJNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LKIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LKIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LKINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LKINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LKJMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LKJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LKJNM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LKMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LKMNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LKNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LKNMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LKNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LMIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LMIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LMINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LMINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LMJKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LMJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LMJNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LMKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LMKNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LMNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LMNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LMNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LNIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LNIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LNIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LNIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LNIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LNIMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LNJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LNJKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LNJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LNJMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LNKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LNKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LNKMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LNMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LNMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LNMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MJIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MJILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MJINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MJINL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MJKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MJLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MJNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MJNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MKIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MKILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MKINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MKINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MKJLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MKJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MKJNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MKLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MKLNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MKNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MKNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MKNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MLIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MLIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MLINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MLINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MLJKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MLJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MLJNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MLKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MLKNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MLNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MLNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MLNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MNIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MNIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MNIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MNIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MNILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MNILK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MNJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MNJKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MNJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MNJLK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MNKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MNKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MNKLJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MNLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MNLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MNLKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NJIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NJIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NJILK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NJILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NJIMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NJIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NJKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NJKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NJLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NJLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NJMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NJMLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NKIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NKIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NKILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NKILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NKIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NKIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NKJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NKJLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NKJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NKJML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NKLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NKLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NKLMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NKMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NKMLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NKMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NLIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NLIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NLIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NLIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NLIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NLIMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NLJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NLJKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NLJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NLJMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NLKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NLKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NLKMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NLMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NLMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NLMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NMIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NMIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NMIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NMIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NMILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NMILK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NMJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NMJKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NMJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NMJLK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NMKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NMKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NMKLJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NMLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NMLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NMLKJ->IJKLM', Xmm, S5old)

    # order of photonic excition in the coupled electron-photon excitation (U1n)
    # here the electron excitation in U keeps at the 1st order

    if nfock2 > 1:
        # add nfock == 2 term
        # here, I only consider nfock2== nfock1 case, 
        #otherwise there are too many combinations (nfock2*nfock1)
        if nfock2 != nfock1:
            assert(False), "nfock1 must be the samme as nfock2 when nfock2>1"
        U1n[1] = numpy.zeros(U1nold[1].shape)

        gU1ov = 1.0*einsum('Jia,IJai->I', g.ov, U1nold[1])
        FU1ov = 1.0*einsum('ia,IJai->IJ', F.ov, U1nold[1])

        Sn[0] += gU1ov
        Sn[1] += FU1ov
        
        Sn[1] += 1.0*einsum('Kia,K,IJai->IJ', g.ov, Snold[0], U1nold[1])
        Sn[1] +=-1.0*einsum('ijab,bi,IJaj->IJ', I.oovv, T1old, U1nold[1])

        U1n[0] +=-1.0*einsum('Jji,IJaj->Iai', g.oo, U1nold[1])
        U1n[0] += 1.0*einsum('Jab,IJbi->Iai', g.vv, U1nold[1])
        U1n[0] +=-1.0*einsum('Jjb,aj,IJbi->Iai', g.ov, T1old, U1nold[1])
        U1n[0] +=-1.0*einsum('Jjb,bi,IJaj->Iai', g.ov, T1old, U1nold[1])
        U1n[0] += 1.0*einsum('Jjb,bj,IJai->Iai', g.ov, T1old, U1nold[1])
       
        U1n[1] +=-1.0*einsum('ji,IJaj->IJai', F.oo, U1nold[1])
        U1n[1] += 1.0*einsum('ab,IJbi->IJai', F.vv, U1nold[1])
        #U1n[1] += 1.0*einsum('IK,JKai->IJai', w, U1nold[1])
        #U1n[1] += 1.0*einsum('JK,IKai->IJai', w, U1nold[1])
        U1n[1] +=-1.0*einsum('Iji,Jaj->IJai', g.oo, U1nold[0])
        U1n[1] += 1.0*einsum('Iab,Jbi->IJai', g.vv, U1nold[0])
        U1n[1] +=-1.0*einsum('Jji,Iaj->IJai', g.oo, U1nold[0])
        U1n[1] += 1.0*einsum('Jab,Ibi->IJai', g.vv, U1nold[0])
        U1n[1] +=-1.0*einsum('jaib,IJbj->IJai', I.ovov, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,aj,IJbi->IJai', F.ov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,bi,IJaj->IJai', F.ov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,Iaj,Jbi->IJai', F.ov, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jb,Ibi,Jaj->IJai', F.ov, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('Ijb,aj,Jbi->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Ijb,bi,Jaj->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Jjb,aj,Ibi->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Jjb,bi,Iaj->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Kji,K,IJaj->IJai', g.oo, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kji,IK,Jaj->IJai', g.oo, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kji,JK,Iaj->IJai', g.oo, Snold[1], U1nold[0])
        U1n[1] += 1.0*einsum('Kab,K,IJbi->IJai', g.vv, Snold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kab,IK,Jbi->IJai', g.vv, Snold[1], U1nold[0])
        U1n[1] += 1.0*einsum('Kab,JK,Ibi->IJai', g.vv, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,Iaj,JKbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Ibi,JKaj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Ibj,JKai->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Jaj,IKbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Jbi,IKaj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Jbj,IKai->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Kai,IJbj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Kaj,IJbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Kbi,IJaj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('jkib,aj,IJbk->IJai', I.ooov, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkib,bj,IJak->IJai', I.ooov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jkib,Iaj,Jbk->IJai', I.ooov, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkib,Ibj,Jak->IJai', I.ooov, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jabc,ci,IJbj->IJai', I.ovvv, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jabc,cj,IJbi->IJai', I.ovvv, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jabc,Ici,Jbj->IJai', I.ovvv, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jabc,Icj,Jbi->IJai', I.ovvv, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,acji,IJbk->IJai', I.oovv, T2old, U1nold[1])
        U1n[1] += 0.5*einsum('jkbc,ackj,IJbi->IJai', I.oovv, T2old, U1nold[1])
        U1n[1] += 0.5*einsum('jkbc,cbji,IJak->IJai', I.oovv, T2old, U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,K,Iaj,Jbi->IJai', g.ov, Snold[0], U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,K,Ibi,Jaj->IJai', g.ov, Snold[0], U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,aj,K,IJbi->IJai', g.ov, T1old, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,aj,IK,Jbi->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,aj,JK,Ibi->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,bi,K,IJaj->IJai', g.ov, T1old, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,bi,IK,Jaj->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,bi,JK,Iaj->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('jkbc,aj,ck,IJbi->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkbc,aj,Ici,Jbk->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jkbc,aj,Ick,Jbi->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,ci,aj,IJbk->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jkbc,ci,bj,IJak->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkbc,ci,Iaj,Jbk->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jkbc,ci,Ibj,Jak->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,cj,Iak,Jbi->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,cj,Ibi,Jak->IJai', I.oovv, T1old, U1nold[0], U1nold[0])

    if nfock2 > 2:
        # add nfock == 3 term
        raise ValueError('nfock2> 2 is not supported at this moment!!!')
    if nfock2 > 3:
        # add nfock == 4 term
        raise ValueError('nfock2> 3 is not supported at this moment!!!')

    return T1, T2, Sn, U1n

def qed_ccsd_sn_u1n_opt_equal(F, I, w, g, h, G, H, nfock, amps):
    '''
    nfock -- order of Sn operator
    nfock -- order of U1n operator
    '''
    # here nfock in Sn and U1n is the same

    T1old, T2old, Snold, U1nold = amps
    Sn = [None]*nfock
    U1n = [None]*nfock

    #epcc_opt is QED-CCSD_S1_U11,
    #T1, T2, Sn[0], U1n[0] = epcc_opt(F, I, w, g, h, G, H, T1old, T2old, Snold[0], U1nold[0])

    S1old = Snold[0]
    U11old = U1nold[0]

    #-------------------------------------------------------------------------
    # copy of  ccsd_opt (since some intermediate avaiable will be used later)
    # CCSD equations
    T1 = F.vo.copy()
    T1 += einsum('xai,x->ai', g.vo, S1old)
    T1 += einsum('x,xai->ai',G, U11old)

    T2 = I.vvoo.copy()
    abij_temp = einsum('xai,xbj->abij', g.vo, U11old)
    T2 += abij_temp
    T2 -= abij_temp.transpose((1,0,2,3))
    T2 -= abij_temp.transpose((0,1,3,2))
    T2 += abij_temp.transpose((1,0,3,2))
    abij_temp = None

    T2A = T2old.copy()
    T1T1 = einsum('ai,bj->abij',T1old, T1old)

    T2A += 0.5*T1T1 #einsum('ai,bj->abij',T1old, T1old)
    T2A -= 0.5*einsum('bi,aj->abij',T1old, T1old)

    Fvv = F.vv.copy()
    Fvv += einsum('xab,x->ab', g.vv, S1old)
    Fvv -= 0.5*einsum('jb,aj->ab',F.ov,T1old)
    Fvv -= einsum('ajcb,cj->ab',I.vovv,T1old)
    Fvv -= 0.5*einsum('jkbc,acjk->ab',I.oovv,T2A)
    Fvv -= einsum('yjb,yaj->ab', g.ov, U11old)

    Foo = F.oo.copy()
    Foo += einsum('xji,x->ji', g.oo, S1old)
    Foo += 0.5*einsum('jb,bi->ji',F.ov,T1old)
    Foo += einsum('jkib,bk->ji',I.ooov,T1old)
    Foo += 0.5*einsum('jkbc,bcik->ji',I.oovv,T2A)
    Foo += einsum('yjb,ybi->ji', g.ov, U11old)
    T2A = None

    gsov = einsum('yia,y->ia', g.ov, S1old)
    gtm = einsum('xjb,bj->x', g.ov, T1old)
    Fov = F.ov.copy()
    Fov += einsum('jkbc,ck->jb',I.oovv,T1old)
    Fov += gsov

    T1 += einsum('ab,bi->ai',Fvv,T1old)
    T1 -= einsum('ji,aj->ai',Foo,T1old)
    T1 += einsum('jb,abij->ai',Fov,T2old)
    T1 -= einsum('ajbi,bj->ai',I.vovo,T1old)
    T1 += 0.5*einsum('ajbc,bcij->ai',I.vovv,T2old)
    T1 -= 0.5*einsum('jkib,abjk->ai',I.ooov,T2old)

    T2B = T2old.copy()
    T2B += einsum('ai,bj->abij',T1old, T1old)
    T2B -= einsum('bi,aj->abij',T1old, T1old)

    Woooo = I.oooo.copy()
    Woooo += einsum('klic,cj->klij',I.ooov,T1old)
    Woooo -= einsum('kljc,ci->klij',I.ooov,T1old)
    Woooo += 0.25*einsum('klcd,cdij->klij',I.oovv,T2B)
    T2 += 0.5*einsum('klij,abkl->abij',Woooo,T2B)
    Woooo = None

    Wvvvv = I.vvvv.copy()
    Wvvvv -= einsum('akcd,bk->abcd',I.vovv,T1old)
    Wvvvv += einsum('bkcd,ak->abcd',I.vovv,T1old)
    Wvvvv += 0.25*einsum('klcd,abkl->abcd',I.oovv,T2B)
    T2 += 0.5*einsum('abcd,cdij->abij',Wvvvv,T2B)
    T2B = None
    Wvvvv = None

    Wovvo = -I.vovo.transpose((1,0,2,3))
    Wovvo -= einsum('bkcd,dj->kbcj',I.vovv,T1old)
    Wovvo += einsum('kljc,bl->kbcj',I.ooov,T1old)
    temp = 0.5*T2old + einsum('dj,bl->dbjl',T1old, T1old)
    Wovvo -= einsum('klcd,dbjl->kbcj',I.oovv,temp)
    temp = einsum('kbcj,acik->abij',Wovvo,T2old)
    temp += einsum('bkcj,ci,ak->abij',I.vovo,T1old, T1old)
    T2 += temp
    T2 -= temp.transpose((0,1,3,2))
    T2 -= temp.transpose((1,0,2,3))
    T2 += temp.transpose((1,0,3,2))
    temp = None
    #Wovvo = None

    Ftemp = Fvv - 0.5*einsum('jb,aj->ab',Fov,T1old)
    temp_ab = einsum('bc,acij->abij',Ftemp,T2old)
    temp_ab += einsum('bkij,ak->abij',I.vooo,T1old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    Ftemp = Foo + 0.5*einsum('jb,bi->ji',Fov,T1old)
    temp_ij = -einsum('kj,abik->abij',Ftemp,T2old)
    temp_ij += einsum('abcj,ci->abij',I.vvvo,T1old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # remaining T1 terms
    T1 += einsum('xab,xbi->ai', g.vv, U11old)
    T1 -= einsum('xji,xaj->ai',g.oo, U11old)

    T1 += einsum('x,xai->ai', gtm, U11old)
    ttt = einsum('jb,bi->ji', gsov, T1old)
    T1 -= einsum('ji,aj->ai', ttt, T1old)

    # Remaining T2 terms
    gtov = einsum('xac,ci->xai', g.vv, T1old)
    gtov -= einsum('xki,ak->xai', g.oo, T1old)
    temp_abij = einsum('xai,xbj->abij', gtov, U11old)
    T2temp = T2old - einsum('bi,aj->abij', T1old, T1old)
    Wmvo = einsum('xkc,acik->xai', g.ov, T2temp)
    temp_abij += einsum('xai,xbj->abij', Wmvo, U11old)
    T2 += temp_abij
    T2 -= temp_abij.transpose((1,0,2,3))
    T2 -= temp_abij.transpose((0,1,3,2))
    T2 += temp_abij.transpose((1,0,3,2))
    temp_abij = None

    gstv = einsum('kc,bk->bc', gsov, T1old)
    temp_ab = -0.5*einsum('bc,acij->abij', gstv, T2old)
    T2 += temp_ab
    T2 -= temp_ab.transpose((1,0,2,3))
    temp_ab = None

    gsto = einsum('kc,cj->kj', gsov, T1old)
    temp_ij = -0.5*einsum('kj,abik->abij', gsto, T2old)
    T2 += temp_ij
    T2 -= temp_ij.transpose((0,1,3,2))
    temp_ij = None

    # S1 and U11 terms
    S1 = H.copy()
    U11 = h.vo.copy()
    S1 += einsum('xia,ai->x', h.ov, T1old)
    S1 += einsum('ia,xai->x', F.ov, U11old)
    S1 += einsum('ia,xai->x', gsov, U11old)

    Xov = einsum('ijab,xbj->xia', I.oovv, U11old)
    S1 += einsum('xia,ai->x', Xov, T1old)

    U11 += 0.5*einsum('xjb,abij->xai', Xov, T2old)

    U11 += einsum('xab,bi->xai', h.vv, T1old)
    U11 -= einsum('xji,aj->xai', h.oo, T1old)

    U11 += einsum('xjb,abij->xai', h.ov, T2temp)

    U11 += einsum('ab,xbi->xai', Fvv, U11old)
    U11 -= einsum('ji,xaj->xai', Foo, U11old)

    U11 += einsum('jabi,xbj->xai', Wovvo, U11old)

    Xvv = einsum('jb,aj->ab', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ab,xbi->xai', Xvv, U11old)

    Xoo = einsum('jb,bi->ji', Fov + gsov, T1old)
    U11 -= 0.5*einsum('ji,xaj->xai', Xoo, U11old)

    Xmm = einsum('yjb,xbj->xy', g.ov, U11old)
    U11 += einsum('xy,yai->xai', Xmm, U11old)

    #S1 += 1.0*einsum('I,I->I', w, S1old)
    #U11 += 1.0*einsum('I,Iai->Iai', w, U11old)

    # end of copy 
    #-------------------------------------------------------------------------
    
    np = w.shape[0]
    w2d = numpy.zeros((np,np))
    for k in range(np):
        w2d[k,k] = w[k]

    Sn[0] = S1
    U1n[0] = U11

    Xmm = einsum('Iia,Jai->IJ', g.ov, U1nold[0])
    govT1 = einsum('Mia,ai->M', g.ov, T1old)

    # order of bare photonic excitation (Sn)
    # here, we only need to add the difference (compared to epcc_opt)
    if nfock > 1:
        # add nfock == 2 term

        S2old = Snold[1]
        # S1
        Sn[0] += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
        
        # S2
        Sn[1] = numpy.zeros((w.shape[0],w.shape[0]))
        S2 = Sn[1]
        
        S2 += 1.0*einsum('IK,JK->IJ', w2d, S2old)
        S2 += 1.0*einsum('JK,IK->IJ', w2d, S2old)

        S2 += Xmm
        S2 += Xmm.T
        S2 += 1.0*einsum('KJ,IK->IJ', Xmm, S2old)
        S2 += 1.0*einsum('KI,JK->IJ', Xmm, S2old)
        S2 -= 1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

        # U11
        g2vo = 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
        g2ov = 1.0*einsum('Jjb,IJ->Ijb', g.ov, S2old)
        
        temp = 0.5*T2old + 0.3333333333333333*T1T1.transpose((1,0,2,3))
        #temp = T2old + T1T1.transpose((1,0,2,3))

        U1n[0] += g2vo
        #U1n[0] += 1.0*einsum('Jai,IJ->Iai', gtov, S2old)
        U1n[0] += 0.5*einsum('Jai,IJ->Iai', gtov, S2old)
        U1n[0] -= 1.0*einsum('Ijb,abji->Iai',  g2ov, temp)


        #
    if nfock > 2:
        # add nfock == 3 term (difference from nfock == 2, no double counting terms)
        Sn[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0]))
        S3 = Sn[2]
        S3old = Snold[2]

        S2 += 0.3333333333333333*einsum('K,IJK->IJ', govT1, S3old)
        S2 += 0.3333333333333333*einsum('K,IKJ->IJ', govT1, S3old)
        S2 += 0.1666666666666666*einsum('K,JKI->IJ', govT1, S3old)
        S2 += 0.1666666666666666*einsum('K,KJI->IJ', govT1, S3old)
       
        S3 += 0.3333333333333333*einsum('IL,JKL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('IL,JLK->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('IL,KLJ->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('IL,LKJ->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('JL,IKL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('JL,ILK->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('JL,KLI->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('JL,LKI->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('KL,IJL->IJK', w2d, S3old)
        S3 += 0.3333333333333333*einsum('KL,ILJ->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('KL,JLI->IJK', w2d, S3old)
        S3 += 0.1666666666666666*einsum('KL,LJI->IJK', w2d, S3old)

        S3 += 0.3333333333333333*einsum('LK,IJL->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LJ,IKL->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LK,ILJ->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LJ,ILK->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LI,JKL->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LK,JLI->IJK', Xmm, S3old)
        S3 += 0.3333333333333333*einsum('LI,JLK->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LJ,KLI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LI,KLJ->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LK,LJI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LJ,LKI->IJK', Xmm, S3old)
        S3 += 0.1666666666666666*einsum('LI,LKJ->IJK', Xmm, S3old)

    if nfock > 3:
        # add nfock == 4 term
        Sn[3] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S4 = Sn[3]
        S4old = Snold[3]

        S3 += 0.08333333333333333*einsum('L,IJKL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IJLK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IKJL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,IKLJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,ILJK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,ILKJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,JKIL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,JLIK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,KJIL->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,KLIJ->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,LJIK->IJK', govT1, S4old)
        S3 += 0.08333333333333333*einsum('L,LKIJ->IJK', govT1, S4old)
        
        S4 += 0.08333333333333333*einsum('IM,JKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KLJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MKJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MLJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MKIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MLIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMLJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MJIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MLIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMKJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MJIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MKIJ->IJKL', w2d, S4old)

        S4 += 0.08333333333333333*einsum('ML,IJKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IJLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IJMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IJML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IKJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IKLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IKMJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IKML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,ILJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,ILKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,ILMJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,ILMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IMJK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IMJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,IMKJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IMKL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,IMLJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,IMLK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,JKIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JKLM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JKML->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,JLIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JLKM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JLMK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,JMIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,JMIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JMKL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,JMLK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,KJIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,KLIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,KLJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,KMIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,KMIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,KMJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,LJIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,LKIM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,LKJM->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,LMIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,LMIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,LMJK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,MJIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,MJIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('ML,MKIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,MKIL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,MKJL->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MK,MLIJ->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MJ,MLIK->IJKL', Xmm, S4old)
        S4 += 0.08333333333333333*einsum('MI,MLJK->IJKL', Xmm, S4old)
 
    if nfock > 4:
        # add nfock == 5 term
        Sn[4] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S5 = Sn[4]
        S5old = Snold[4]

        S4 += 0.016666666666666666*einsum('M,IJKLM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJKML->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJLKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJLMK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJMKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IJMLK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKJLM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKJML->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKLJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKLMJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKMJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IKMLJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILJKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILJMK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILKJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILKMJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILMJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,ILMKJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMJKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMJLK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMKJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMKLJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMLJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,IMLKJ->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JKILM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JKIML->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JKLMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JKMLI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JLIKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JLIMK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JLKMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JLMKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JMIKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,JMILK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JMKLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,JMLKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KJILM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KJIML->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KJLMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KJMLI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KLIJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KLIMJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KLJMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KLMJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KMIJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,KMILJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KMJLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,KMLJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LJIKM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LJIMK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LJKMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LJMKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LKIJM->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LKIMJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LKJMI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LKMJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LMIJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,LMIKJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LMJKI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,LMKJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MJIKL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MJILK->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MJKLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MJLKI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MKIJL->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MKILJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MKJLI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MKLJI->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MLIJK->IJKL', govT1, S5old)
        S4 += 0.016666666666666666*einsum('M,MLIKJ->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MLJKI->IJKL', govT1, S5old)
        S4 += 0.008333333333333333*einsum('M,MLKJI->IJKL', govT1, S5old)
        
        Xw = Xmm 

        S5 += 0.016666666666666666*einsum('IN,JKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLKJI->IJKLM', w2d, S5old)

        S5 += 0.016666666666666666*einsum('NM,IJKLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJKMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJLKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJLMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJLNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJMKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJMLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJMNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJMNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJNKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJNKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IJNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJNLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IJNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IJNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKJLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKJMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKJNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKJNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKLJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKLMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKLNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKMJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKMLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKMNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKMNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKNJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKNJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,IKNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKNLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IKNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IKNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILJKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILJMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILJNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILJNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILKJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILKMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILKNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILMJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILMKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILMNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILMNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILNJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILNJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,ILNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILNKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,ILNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,ILNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMJKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMJLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMJNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMJNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMKJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMKLN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMKNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMLJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMLKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMLNJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMLNK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMNJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMNJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,IMNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMNKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,IMNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,IMNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INJKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INJKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INJLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INJLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INJMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INJML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INKJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INKJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INKLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INKLM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INKMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INKML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INLJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INLJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,INLKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INLKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INLMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INLMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INMJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INMJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,INMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INMKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,INMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,INMLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JKILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JKIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JKINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JKINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKLMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JKLNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKLNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKMLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JKMNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKMNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JKNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKNLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JKNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JKNML->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JLIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JLIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JLINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JLINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLKMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JLKNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLKNM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLMKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JLMNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLMNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JLNKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLNKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JLNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JLNMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JMIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JMILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JMINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JMINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMKLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JMKNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMKNL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMLKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JMLNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMLNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JMNKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMNKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JMNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JMNLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JNIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JNIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,JNILK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JNILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,JNIMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,JNIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JNKLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNKLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JNKMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNKML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,JNLKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNLKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JNLMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNLMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,JNMKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNMKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,JNMLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,JNMLK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KJILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KJIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KJINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KJINM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KJLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KJMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KJNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KJNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KLIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KLIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KLINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KLINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KLJMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KLJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KLJNM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KLMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KLMNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KLNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KLNMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KLNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KMIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KMILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KMINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KMINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KMJLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KMJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KMJNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KMLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KMLNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KMNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KMNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KMNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KNIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KNIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,KNILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KNILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,KNIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,KNIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KNJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KNJLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KNJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,KNJML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,KNLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KNLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KNLMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,KNMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,KNMLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,KNMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LJIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LJIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LJINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LJINM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LJKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LJMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LJNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LJNMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LKIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LKIMN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LKINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LKINM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LKJMN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LKJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LKJNM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LKMNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LKMNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LKNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LKNMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LKNMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LMIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LMIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LMINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LMINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LMJKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LMJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LMJNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LMKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LMKNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LMNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LMNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LMNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LNIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LNIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,LNIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LNIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,LNIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,LNIMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LNJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LNJKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LNJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,LNJMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,LNKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LNKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LNKMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,LNMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,LNMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,LNMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MJIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MJILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MJINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MJINL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MJKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MJLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MJNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MJNLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MKIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MKILN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MKINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MKINL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MKJLN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MKJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MKJNL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MKLNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MKLNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MKNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MKNLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MKNLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MLIJN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MLIKN->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MLINJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MLINK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MLJKN->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MLJNI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MLJNK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MLKNI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MLKNJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MLNJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MLNKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MLNKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MNIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MNIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,MNIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MNIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,MNILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,MNILK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MNJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MNJKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MNJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,MNJLK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,MNKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MNKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MNKLJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,MNLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,MNLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,MNLKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NJIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NJIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NJILK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NJILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NJIMK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NJIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NJKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NJKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NJLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NJLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NJMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NJMLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NKIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NKIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NKILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NKILM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NKIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NKIML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NKJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NKJLM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NKJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NKJML->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NKLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NKLMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NKLMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NKMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NKMLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NKMLJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NLIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NLIJM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NM,NLIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NLIKM->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NLIMJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NLIMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NLJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NLJKM->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NLJMI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NLJMK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NM,NLKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NLKMI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NLKMJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NLMJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NLMKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NLMKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NMIJK->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NMIJL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NL,NMIKJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NMIKL->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NK,NMILJ->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NJ,NMILK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NMJKI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NMJKL->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NMJLI->IJKLM', Xmm, S5old)
        S5 += 0.016666666666666666*einsum('NI,NMJLK->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NL,NMKJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NMKLI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NMKLJ->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NK,NMLJI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NJ,NMLKI->IJKLM', Xmm, S5old)
        S5 += 0.008333333333333333*einsum('NI,NMLKJ->IJKLM', Xmm, S5old)

    # order of photonic excition in the coupled electron-photon excitation (U1n)
    # here the electron excitation in U keeps at the 1st order

    if nfock > 1:
        # add nfock == 2 term
        # here, I only consider nfock2== nfock1 case, 
        #otherwise there are too many combinations (nfock2*nfock1)

        gU1ov = 1.0*einsum('Jia,IJai->I', g.ov, U1nold[1])
        FU1ov += 1.0*einsum('ia,IJai->IJ', F.ov, U1nold[1])

        Sn[0] += gU1ov
        Sn[1] += FU1ov
        Sn[1] += 1.0*einsum('Kia,K,IJai->IJ', g.ov, Snold[0], U1nold[1])
        Sn[1] +=-1.0*einsum('ijab,bi,IJaj->IJ', I.oovv, T1old, U1nold[1])
       
        U1n[0] +=-1.0*einsum('Jji,IJaj->Iai', g.oo, U1nold[1])
        U1n[0] += 1.0*einsum('Jab,IJbi->Iai', g.vv, U1nold[1])
        U1n[0] +=-1.0*einsum('Jjb,aj,IJbi->Iai', g.ov, T1old, U1nold[1])
        U1n[0] +=-1.0*einsum('Jjb,bi,IJaj->Iai', g.ov, T1old, U1nold[1])
        U1n[0] += 1.0*einsum('Jjb,bj,IJai->Iai', g.ov, T1old, U1nold[1])
       
        U1n[1] +=-1.0*einsum('ji,IJaj->IJai', F.oo, U1nold[1])
        U1n[1] += 1.0*einsum('ab,IJbi->IJai', F.vv, U1nold[1])

        #U1n[1] += 1.0*einsum('IK,JKai->IJai', w, U1nold[1])
        #U1n[1] += 1.0*einsum('JK,IKai->IJai', w, U1nold[1])
        U1n[1] +=-1.0*einsum('Iji,Jaj->IJai', g.oo, U1nold[0])
        U1n[1] += 1.0*einsum('Iab,Jbi->IJai', g.vv, U1nold[0])
        U1n[1] +=-1.0*einsum('Jji,Iaj->IJai', g.oo, U1nold[0])
        U1n[1] += 1.0*einsum('Jab,Ibi->IJai', g.vv, U1nold[0])
        U1n[1] +=-1.0*einsum('jaib,IJbj->IJai', I.ovov, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,aj,IJbi->IJai', F.ov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,bi,IJaj->IJai', F.ov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jb,Iaj,Jbi->IJai', F.ov, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jb,Ibi,Jaj->IJai', F.ov, U1nold[0], U1nold[0])

        U1n[1] +=-1.0*einsum('Ijb,aj,Jbi->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Ijb,bi,Jaj->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Jjb,aj,Ibi->IJai', g.ov, T1old, U1nold[0])
        U1n[1] +=-1.0*einsum('Jjb,bi,Iaj->IJai', g.ov, T1old, U1nold[0])

        U1n[1] +=-1.0*einsum('Kji,K,IJaj->IJai', g.oo, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kji,IK,Jaj->IJai', g.oo, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kji,JK,Iaj->IJai', g.oo, Snold[1], U1nold[0])
        U1n[1] += 1.0*einsum('Kab,K,IJbi->IJai', g.vv, Snold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kab,IK,Jbi->IJai', g.vv, Snold[1], U1nold[0])
        U1n[1] += 1.0*einsum('Kab,JK,Ibi->IJai', g.vv, Snold[1], U1nold[0])

        U1n[1] +=-1.0*einsum('Kjb,Iaj,JKbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Ibi,JKaj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Ibj,JKai->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Jaj,IKbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Jbi,IKaj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Jbj,IKai->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] += 1.0*einsum('Kjb,Kai,IJbj->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Kaj,IJbi->IJai', g.ov, U1nold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,Kbi,IJaj->IJai', g.ov, U1nold[0], U1nold[1])
        
        U1n[1] +=-1.0*einsum('jkib,aj,IJbk->IJai', I.ooov, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkib,bj,IJak->IJai', I.ooov, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jkib,Iaj,Jbk->IJai', I.ooov, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkib,Ibj,Jak->IJai', I.ooov, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jabc,ci,IJbj->IJai', I.ovvv, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jabc,cj,IJbi->IJai', I.ovvv, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jabc,Ici,Jbj->IJai', I.ovvv, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jabc,Icj,Jbi->IJai', I.ovvv, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,acji,IJbk->IJai', I.oovv, T2old, U1nold[1])
        U1n[1] += 0.5*einsum('jkbc,ackj,IJbi->IJai', I.oovv, T2old, U1nold[1])
        U1n[1] += 0.5*einsum('jkbc,cbji,IJak->IJai', I.oovv, T2old, U1nold[1])
        
        U1n[1] +=-1.0*einsum('Kjb,K,Iaj,Jbi->IJai', g.ov, Snold[0], U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,K,Ibi,Jaj->IJai', g.ov, Snold[0], U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,aj,K,IJbi->IJai', g.ov, T1old, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,aj,IK,Jbi->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,aj,JK,Ibi->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,bi,K,IJaj->IJai', g.ov, T1old, Snold[0], U1nold[1])
        U1n[1] +=-1.0*einsum('Kjb,bi,IK,Jaj->IJai', g.ov, T1old, Snold[1], U1nold[0])
        U1n[1] +=-1.0*einsum('Kjb,bi,JK,Iaj->IJai', g.ov, T1old, Snold[1], U1nold[0])
        
        U1n[1] +=-1.0*einsum('jkbc,aj,ck,IJbi->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkbc,aj,Ici,Jbk->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jkbc,aj,Ick,Jbi->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,ci,aj,IJbk->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] +=-1.0*einsum('jkbc,ci,bj,IJak->IJai', I.oovv, T1old, T1old, U1nold[1])
        U1n[1] += 1.0*einsum('jkbc,ci,Iaj,Jbk->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] +=-1.0*einsum('jkbc,ci,Ibj,Jak->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,cj,Iak,Jbi->IJai', I.oovv, T1old, U1nold[0], U1nold[0])
        U1n[1] += 1.0*einsum('jkbc,cj,Ibi,Jak->IJai', I.oovv, T1old, U1nold[0], U1nold[0])

        if nfock > 2:
            # 3_2 case
            # 3_u12 case, take the difference between 3_u12 and 2_u12 (diff32_u12.log)
            Sn[1] += 0.3333333333333333*einsum('Kia,ai,IJK->IJ', g.ov, T1old, Snold[2])
            Sn[1] += 0.3333333333333333*einsum('Kia,ai,IKJ->IJ', g.ov, T1old, Snold[2])
            Sn[1] += 0.16666666666666666*einsum('Kia,ai,JKI->IJ', g.ov, T1old, Snold[2])
            Sn[1] += 0.16666666666666666*einsum('Kia,ai,KJI->IJ', g.ov, T1old, Snold[2])

            Sn[2] += 0.3333333333333333*einsum('IL,JKL->IJK', w, Snold[2])
            Sn[2] += 0.3333333333333333*einsum('IL,JLK->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('IL,KLJ->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('IL,LKJ->IJK', w, Snold[2])
            Sn[2] += 0.3333333333333333*einsum('JL,IKL->IJK', w, Snold[2])
            Sn[2] += 0.3333333333333333*einsum('JL,ILK->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('JL,KLI->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('JL,LKI->IJK', w, Snold[2])
            Sn[2] += 0.3333333333333333*einsum('KL,IJL->IJK', w, Snold[2])
            Sn[2] += 0.3333333333333333*einsum('KL,ILJ->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('KL,JLI->IJK', w, Snold[2])
            Sn[2] += 0.16666666666666666*einsum('KL,LJI->IJK', w, Snold[2])
            Sn[2] += 1.0*einsum('Iia,JKai->IJK', g.ov, U1nold[1])
            Sn[2] += 1.0*einsum('Jia,IKai->IJK', g.ov, U1nold[1])
            Sn[2] += 1.0*einsum('Kia,IJai->IJK', g.ov, U1nold[1])
            Sn[2] += 1.0*einsum('Lia,IL,JKai->IJK', g.ov, Snold[1], U1nold[1])
            Sn[2] += 1.0*einsum('Lia,JL,IKai->IJK', g.ov, Snold[1], U1nold[1])
            Sn[2] += 1.0*einsum('Lia,KL,IJai->IJK', g.ov, Snold[1], U1nold[1])
            Sn[2] += 0.3333333333333333*einsum('Lia,IJL,Kai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.3333333333333333*einsum('Lia,IKL,Jai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.3333333333333333*einsum('Lia,ILJ,Kai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.3333333333333333*einsum('Lia,ILK,Jai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.3333333333333333*einsum('Lia,JKL,Iai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,JLI,Kai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.3333333333333333*einsum('Lia,JLK,Iai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,KLI,Jai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,KLJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,LJI,Kai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,LKI,Jai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += 0.16666666666666666*einsum('Lia,LKJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
            Sn[2] += -1.0*einsum('ijab,Ibi,JKaj->IJK', I.oovv, U1nold[0], U1nold[1])
            Sn[2] += -1.0*einsum('ijab,Jbi,IKaj->IJK', I.oovv, U1nold[0], U1nold[1])
            Sn[2] += -1.0*einsum('ijab,Kbi,IJaj->IJK', I.oovv, U1nold[0], U1nold[1])

            U1n[1] += 0.3333333333333333*einsum('Kai,IJK->IJai', g.vo, Snold[2])
            U1n[1] += 0.3333333333333333*einsum('Kai,IKJ->IJai', g.vo, Snold[2])
            U1n[1] += 0.16666666666666666*einsum('Kai,JKI->IJai', g.vo, Snold[2])
            U1n[1] += 0.16666666666666666*einsum('Kai,KJI->IJai', g.vo, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kji,aj,IJK->IJai', g.oo, T1old, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kji,aj,IKJ->IJai', g.oo, T1old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kji,aj,JKI->IJai', g.oo, T1old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kji,aj,KJI->IJai', g.oo, T1old, Snold[2])
            U1n[1] += 0.3333333333333333*einsum('Kab,bi,IJK->IJai', g.vv, T1old, Snold[2])
            U1n[1] += 0.3333333333333333*einsum('Kab,bi,IKJ->IJai', g.vv, T1old, Snold[2])
            U1n[1] += 0.16666666666666666*einsum('Kab,bi,JKI->IJai', g.vv, T1old, Snold[2])
            U1n[1] += 0.16666666666666666*einsum('Kab,bi,KJI->IJai', g.vv, T1old, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IJK->IJai', g.ov, T2old, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IKJ->IJai', g.ov, T2old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kjb,abji,JKI->IJai', g.ov, T2old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kjb,abji,KJI->IJai', g.ov, T2old, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IJK->IJai', g.ov, T1old, T1old, Snold[2])
            U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IKJ->IJai', g.ov, T1old, T1old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kjb,bi,aj,JKI->IJai', g.ov, T1old, T1old, Snold[2])
            U1n[1] += -0.16666666666666666*einsum('Kjb,bi,aj,KJI->IJai', g.ov, T1old, T1old, Snold[2])

    return T1, T2, Sn, U1n

