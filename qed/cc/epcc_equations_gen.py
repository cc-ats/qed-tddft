import numpy
from pyscf import lib
from cqcpy import cc_equations

einsum = lib.einsum

def epcc1_11_gen(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # F1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # F2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1 equation
    S1 = H.copy()
    #S1 += 1.0*einsum('I,I->I', w, S1)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    #U11 += 1.0*einsum('I,Iai->Iai', w, U11)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)

    return T1,T2,S1,U11

def epcc2_11_gen(F, I, w, g, h, G, H, T1old, T2old, S1old, S2old, U11old):
    # CCSD equations
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # F1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # F2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1 equation
    S1 = H.copy()
    #S1 += 1.0*einsum('I->I', H)
    #S1 += 1.0*einsum('IJ,J->I', w, S1old)
    S1 += 1.0*einsum('J,IJ->I', G, S2old)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # S2 equation
    nm = S1.shape[0]
    S2 = numpy.zeros((nm,nm))
    #S2 += 1.0*einsum('IK,JK->IJ', w, S2old)
    #S2 += 1.0*einsum('JK,IK->IJ', w, S2old)
    S2 += 1.0*einsum('Iia,Jai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Jia,Iai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
    S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
    S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    #U11 += 1.0*einsum('Iai->Iai', h)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    #U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('Jjb,abij,IJ->Iai', g.ov, T2old, S2old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)

    return T1,T2,S1,S2,U11

def epcc2_12_gen(F, I, w, g, h, G, H, T1old, T2old, S1old, S2old, U11old, U12old):

    # CCSD equations
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # F1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # F2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1
    S1 = H.copy()
    #S1 += 1.0*einsum('I->I', H)
    #S1 += 1.0*einsum('IJ,J->I', w, S1old)
    S1 += 1.0*einsum('J,IJ->I', G, S2old)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,IJai->I', g.ov, U12old)
    S1 += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # S2
    nm = S1.shape[0]
    S2 = numpy.zeros((nm,nm))
    #S2 += 1.0*einsum('IK,JK->IJ', w, S2old)
    #S2 += 1.0*einsum('JK,IK->IJ', w, S2old)
    S2 += 1.0*einsum('ia,IJai->IJ', F.ov, U12old)
    S2 += 1.0*einsum('Iia,Jai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Jia,Iai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Kia,K,IJai->IJ', g.ov, S1old, U12old)
    S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
    S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
    S2 += -1.0*einsum('ijab,bi,IJaj->IJ', I.oovv, T1old, U12old)
    S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    #U11 += 1.0*einsum('Iai->Iai', h)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    #U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old)
    U11 += 1.0*einsum('J,IJai->Iai', G, U12old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += -1.0*einsum('Jji,IJaj->Iai', g.oo, U12old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += 1.0*einsum('Jab,IJbi->Iai', g.vv, U12old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,IJaj->Iai', g.ov, T1old, U12old)
    U11 += -1.0*einsum('Jjb,aj,IJbi->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,bj,IJai->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,abij,IJ->Iai', g.ov, T2old, S2old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)

    # U12 equations
    nv,no = T1.shape
    U12 = numpy.zeros((nm, nm, nv, no))
    U12 += -1.0*einsum('ji,IJaj->IJai', F.oo, U12old)
    U12 += 1.0*einsum('ab,IJbi->IJai', F.vv, U12old)
    #U12 += 1.0*einsum('IK,JKai->IJai', w, U12old)
    #U12 += 1.0*einsum('JK,IKai->IJai', w, U12old)
    U12 += -1.0*einsum('Iji,Jaj->IJai', h.oo, U11old)
    U12 += -1.0*einsum('Jji,Iaj->IJai', h.oo, U11old)
    U12 += 1.0*einsum('Iab,Jbi->IJai', h.vv, U11old)
    U12 += 1.0*einsum('Jab,Ibi->IJai', h.vv, U11old)
    U12 += -1.0*einsum('ajbi,IJbj->IJai', I.vovo, U12old)
    U12 += -1.0*einsum('jb,bi,IJaj->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,aj,IJbi->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,Ibi,Jaj->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('jb,Iaj,Jbi->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('Kji,K,IJaj->IJai', g.oo, S1old, U12old)
    U12 += -1.0*einsum('Kji,IK,Jaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Kji,JK,Iaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Ijb,bi,Jaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Ijb,aj,Jbi->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,bi,Iaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,aj,Ibi->IJai', h.ov, T1old, U11old)
    U12 += 1.0*einsum('Kab,K,IJbi->IJai', g.vv, S1old, U12old)
    U12 += 1.0*einsum('Kab,IK,Jbi->IJai', g.vv, S2old, U11old)
    U12 += 1.0*einsum('Kab,JK,Ibi->IJai', g.vv, S2old, U11old)
    U12 += -1.0*einsum('jkib,aj,IJbk->IJai', I.ooov, T1old, U12old)
    U12 += 1.0*einsum('jkib,bj,IJak->IJai', I.ooov, T1old, U12old)
    U12 += -1.0*einsum('jkib,Iaj,Jbk->IJai', I.ooov, U11old, U11old)
    U12 += 1.0*einsum('jkib,Ibj,Jak->IJai', I.ooov, U11old, U11old)
    U12 += -1.0*einsum('ajbc,ci,IJbj->IJai', I.vovv, T1old, U12old)
    U12 += 1.0*einsum('ajbc,cj,IJbi->IJai', I.vovv, T1old, U12old)
    U12 += -1.0*einsum('ajbc,Ici,Jbj->IJai', I.vovv, U11old, U11old)
    U12 += 1.0*einsum('ajbc,Icj,Jbi->IJai', I.vovv, U11old, U11old)
    U12 += -1.0*einsum('Kjb,Ibi,JKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Iaj,JKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Ibj,JKai->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jbi,IKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jaj,IKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Jbj,IKai->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Kai,IJbj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kbi,IJaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kaj,IJbi->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('jkbc,acij,IJbk->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,cbij,IJak->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,acjk,IJbi->IJai', I.oovv, T2old, U12old)
    U12 += -1.0*einsum('Kjb,bi,K,IJaj->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,aj,K,IJbi->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,bi,IK,Jaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,IK,Jbi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,bi,JK,Iaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,JK,Ibi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,K,Ibi,Jaj->IJai', g.ov, S1old, U11old, U11old)
    U12 += -1.0*einsum('Kjb,K,Iaj,Jbi->IJai', g.ov, S1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,ci,aj,IJbk->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,ci,bj,IJak->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,aj,ck,IJbi->IJai', I.oovv, T1old, T1old, U12old)
    U12 += 1.0*einsum('jkbc,ci,Iaj,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,ci,Ibj,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,aj,Ici,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Ibi,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,aj,Ick,Jbi->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Iak,Jbi->IJai', I.oovv, T1old, U11old, U11old)

    return T1,T2,S1,S2,U11,U12


### BRADEN WEIGHT ORIGINAL SLOW CODES ###

def QED_TEMPLATE(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # UPDATE T1

    # Update T2

    # Initialize and populate S1 operator
    S1 = H.copy()


    # Initialize and populate U11 operator
    U11 = h.vo.copy()

    return T1, T2, S1, U11

def QED_CC_T1_T2_S1_U11_gen(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    #T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # UPDATE T1
    T1 = 1.0*einsum('ai->ai', F.vo)
    T1 += -1.0*einsum('ji,aj->ai', F.oo, T1old)
    T1 += 1.0*einsum('ab,bi->ai', F.vv, T1old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('jb,abji->ai', F.ov, T2old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('jaib,bj->ai', I.ovov, T1old)
    T1 += 0.5*einsum('jkib,abkj->ai', I.ooov, T2old)
    T1 += -0.5*einsum('jabc,cbji->ai', I.ovvv, T2old)
    T1 += -1.0*einsum('jb,bi,aj->ai', F.ov, T1old, T1old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,abji,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('jkib,aj,bk->ai', I.ooov, T1old, T1old)
    T1 += 1.0*einsum('jabc,ci,bj->ai', I.ovvv, T1old, T1old)
    T1 += -0.5*einsum('jkbc,aj,cbki->ai', I.oovv, T1old, T2old)
    T1 += -0.5*einsum('jkbc,ci,abkj->ai', I.oovv, T1old, T2old)
    T1 += 1.0*einsum('jkbc,cj,abki->ai', I.oovv, T1old, T2old)
    T1 += 1.0*einsum('jkbc,ci,aj,bk->ai', I.oovv, T1old, T1old, T1old)

    # Update T2
    T2 = 1.0*einsum('baji->abij', I.vvoo)
    T2 += 1.0*einsum('ki,bakj->abij', F.oo, T2old)
    T2 += -1.0*einsum('kj,baki->abij', F.oo, T2old)
    T2 += 1.0*einsum('ac,bcji->abij', F.vv, T2old)
    T2 += -1.0*einsum('bc,acji->abij', F.vv, T2old)
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('kaji,bk->abij', I.ovoo, T1old)
    T2 += 1.0*einsum('kbji,ak->abij', I.ovoo, T1old)
    T2 += -1.0*einsum('baic,cj->abij', I.vvov, T1old)
    T2 += 1.0*einsum('bajc,ci->abij', I.vvov, T1old)
    T2 += -0.5*einsum('klji,balk->abij', I.oooo, T2old)
    T2 += 1.0*einsum('kaic,bckj->abij', I.ovov, T2old)
    T2 += -1.0*einsum('kajc,bcki->abij', I.ovov, T2old)
    T2 += -1.0*einsum('kbic,ackj->abij', I.ovov, T2old)
    T2 += 1.0*einsum('kbjc,acki->abij', I.ovov, T2old)
    T2 += -0.5*einsum('bacd,dcji->abij', I.vvvv, T2old)
    T2 += -1.0*einsum('kc,ak,bcji->abij', F.ov, T1old, T2old)
    T2 += 1.0*einsum('kc,bk,acji->abij', F.ov, T1old, T2old)
    T2 += 1.0*einsum('kc,ci,bakj->abij', F.ov, T1old, T2old)
    T2 += -1.0*einsum('kc,cj,baki->abij', F.ov, T1old, T2old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bakj,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,baki,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Iac,bcji,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,acji,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('klji,bk,al->abij', I.oooo, T1old, T1old)
    T2 += 1.0*einsum('kaic,cj,bk->abij', I.ovov, T1old, T1old)
    T2 += -1.0*einsum('kajc,ci,bk->abij', I.ovov, T1old, T1old)
    T2 += -1.0*einsum('kbic,cj,ak->abij', I.ovov, T1old, T1old)
    T2 += 1.0*einsum('kbjc,ci,ak->abij', I.ovov, T1old, T1old)
    T2 += 1.0*einsum('bacd,di,cj->abij', I.vvvv, T1old, T1old)
    T2 += 1.0*einsum('Ikc,acji,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acki,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,ackj,Ibi->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,baki,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bakj,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcji,Iak->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcki,Iaj->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bckj,Iai->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('klic,ak,bclj->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('klic,bk,aclj->abij', I.ooov, T1old, T2old)
    T2 += 0.5*einsum('klic,cj,balk->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('klic,ck,balj->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('kljc,ak,bcli->abij', I.ooov, T1old, T2old)
    T2 += 1.0*einsum('kljc,bk,acli->abij', I.ooov, T1old, T2old)
    T2 += -0.5*einsum('kljc,ci,balk->abij', I.ooov, T1old, T2old)
    T2 += 1.0*einsum('kljc,ck,bali->abij', I.ooov, T1old, T2old)
    T2 += 0.5*einsum('kacd,bk,dcji->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kacd,di,bckj->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kacd,dj,bcki->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kacd,dk,bcji->abij', I.ovvv, T1old, T2old)
    T2 += -0.5*einsum('kbcd,ak,dcji->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kbcd,di,ackj->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kbcd,dj,acki->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kbcd,dk,acji->abij', I.ovvv, T1old, T2old)
    T2 += 0.5*einsum('klcd,adji,bclk->abij', I.oovv, T2old, T2old)
    T2 += -1.0*einsum('klcd,adki,bclj->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,baki,dclj->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,bdji,aclk->abij', I.oovv, T2old, T2old)
    T2 += 1.0*einsum('klcd,bdki,aclj->abij', I.oovv, T2old, T2old)
    T2 += 0.25*einsum('klcd,dcji,balk->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,dcki,balj->abij', I.oovv, T2old, T2old)
    T2 += -1.0*einsum('Ikc,ak,bcji,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,bk,acji,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bakj,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,cj,ak,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,baki,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('klic,cj,bk,al->abij', I.ooov, T1old, T1old, T1old)
    T2 += 1.0*einsum('kljc,ci,bk,al->abij', I.ooov, T1old, T1old, T1old)
    T2 += -1.0*einsum('kacd,di,cj,bk->abij', I.ovvv, T1old, T1old, T1old)
    T2 += 1.0*einsum('kbcd,di,cj,ak->abij', I.ovvv, T1old, T1old, T1old)
    T2 += -1.0*einsum('klcd,ak,dl,bcji->abij', I.oovv, T1old, T1old, T2old)
    T2 += -0.5*einsum('klcd,bk,al,dcji->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,bk,dl,acji->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,di,ak,bclj->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,bk,aclj->abij', I.oovv, T1old, T1old, T2old)
    T2 += -0.5*einsum('klcd,di,cj,balk->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,ck,balj->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,dj,ak,bcli->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,dj,bk,acli->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,dj,ck,bali->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,cj,bk,al->abij', I.oovv, T1old, T1old, T1old, T1old)




    # Initialize and populate S1 operator
    S1 = H.copy()
    #S1 += 1.0*einsum('IJ,J->I', w, S1old) # Why do we comment this out ? Gives error actually. ~ BMW
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', g.ov, T1old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)


    # Initialize and populate U11 operator
    U11 = h.vo.copy()
    U11 += 1.0*einsum('Iai->Iai', g.vo)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    #U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old) # Why do we comment this out ? Gives error actually. ~ BMW
    U11 += -1.0*einsum('Iji,aj->Iai', g.oo, T1old)
    U11 += 1.0*einsum('Iab,bi->Iai', g.vv, T1old)
    U11 += -1.0*einsum('Ijb,abji->Iai', g.ov, T2old)
    U11 += -1.0*einsum('jaib,Ibj->Iai', I.ovov, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', g.ov, T1old, T1old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jabc,ci,Ibj->Iai', I.ovvv, T1old, U11old)
    U11 += -1.0*einsum('jabc,cj,Ibi->Iai', I.ovvv, T1old, U11old)
    U11 += 1.0*einsum('jkbc,acji,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += 0.5*einsum('jkbc,ackj,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += 0.5*einsum('jkbc,cbji,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)

    return T1, T2, S1, U11

def QED_CC_T1_T2_S1_S2_U11_gen(F, I, w, g, h, G, H, T1old, T2old, S1old, U11old):
    # CCSD equations
    #T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # UPDATE T1
    T1 = 1.0*einsum('ai->ai', F.vo)
    T1 += -1.0*einsum('ji,aj->ai', F.oo, T1old)
    T1 += 1.0*einsum('ab,bi->ai', F.vv, T1old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('jb,abji->ai', F.ov, T2old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('jaib,bj->ai', I.ovov, T1old)
    T1 += 0.5*einsum('jkib,abkj->ai', I.ooov, T2old)
    T1 += -0.5*einsum('jabc,cbji->ai', I.ovvv, T2old)
    T1 += -1.0*einsum('jb,bi,aj->ai', F.ov, T1old, T1old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,abji,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('jkib,aj,bk->ai', I.ooov, T1old, T1old)
    T1 += 1.0*einsum('jabc,ci,bj->ai', I.ovvv, T1old, T1old)
    T1 += -0.5*einsum('jkbc,aj,cbki->ai', I.oovv, T1old, T2old)
    T1 += -0.5*einsum('jkbc,ci,abkj->ai', I.oovv, T1old, T2old)
    T1 += 1.0*einsum('jkbc,cj,abki->ai', I.oovv, T1old, T2old)
    T1 += 1.0*einsum('jkbc,ci,aj,bk->ai', I.oovv, T1old, T1old, T1old)

    # Update T2
    T2 = 1.0*einsum('baji->abij', I.vvoo)
    T2 += 1.0*einsum('ki,bakj->abij', F.oo, T2old)
    T2 += -1.0*einsum('kj,baki->abij', F.oo, T2old)
    T2 += 1.0*einsum('ac,bcji->abij', F.vv, T2old)
    T2 += -1.0*einsum('bc,acji->abij', F.vv, T2old)
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('kaji,bk->abij', I.ovoo, T1old)
    T2 += 1.0*einsum('kbji,ak->abij', I.ovoo, T1old)
    T2 += -1.0*einsum('baic,cj->abij', I.vvov, T1old)
    T2 += 1.0*einsum('bajc,ci->abij', I.vvov, T1old)
    T2 += -0.5*einsum('klji,balk->abij', I.oooo, T2old)
    T2 += 1.0*einsum('kaic,bckj->abij', I.ovov, T2old)
    T2 += -1.0*einsum('kajc,bcki->abij', I.ovov, T2old)
    T2 += -1.0*einsum('kbic,ackj->abij', I.ovov, T2old)
    T2 += 1.0*einsum('kbjc,acki->abij', I.ovov, T2old)
    T2 += -0.5*einsum('bacd,dcji->abij', I.vvvv, T2old)
    T2 += -1.0*einsum('kc,ak,bcji->abij', F.ov, T1old, T2old)
    T2 += 1.0*einsum('kc,bk,acji->abij', F.ov, T1old, T2old)
    T2 += 1.0*einsum('kc,ci,bakj->abij', F.ov, T1old, T2old)
    T2 += -1.0*einsum('kc,cj,baki->abij', F.ov, T1old, T2old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bakj,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,baki,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Iac,bcji,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,acji,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('klji,bk,al->abij', I.oooo, T1old, T1old)
    T2 += 1.0*einsum('kaic,cj,bk->abij', I.ovov, T1old, T1old)
    T2 += -1.0*einsum('kajc,ci,bk->abij', I.ovov, T1old, T1old)
    T2 += -1.0*einsum('kbic,cj,ak->abij', I.ovov, T1old, T1old)
    T2 += 1.0*einsum('kbjc,ci,ak->abij', I.ovov, T1old, T1old)
    T2 += 1.0*einsum('bacd,di,cj->abij', I.vvvv, T1old, T1old)
    T2 += 1.0*einsum('Ikc,acji,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acki,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,ackj,Ibi->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,baki,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bakj,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcji,Iak->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcki,Iaj->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bckj,Iai->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('klic,ak,bclj->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('klic,bk,aclj->abij', I.ooov, T1old, T2old)
    T2 += 0.5*einsum('klic,cj,balk->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('klic,ck,balj->abij', I.ooov, T1old, T2old)
    T2 += -1.0*einsum('kljc,ak,bcli->abij', I.ooov, T1old, T2old)
    T2 += 1.0*einsum('kljc,bk,acli->abij', I.ooov, T1old, T2old)
    T2 += -0.5*einsum('kljc,ci,balk->abij', I.ooov, T1old, T2old)
    T2 += 1.0*einsum('kljc,ck,bali->abij', I.ooov, T1old, T2old)
    T2 += 0.5*einsum('kacd,bk,dcji->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kacd,di,bckj->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kacd,dj,bcki->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kacd,dk,bcji->abij', I.ovvv, T1old, T2old)
    T2 += -0.5*einsum('kbcd,ak,dcji->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kbcd,di,ackj->abij', I.ovvv, T1old, T2old)
    T2 += -1.0*einsum('kbcd,dj,acki->abij', I.ovvv, T1old, T2old)
    T2 += 1.0*einsum('kbcd,dk,acji->abij', I.ovvv, T1old, T2old)
    T2 += 0.5*einsum('klcd,adji,bclk->abij', I.oovv, T2old, T2old)
    T2 += -1.0*einsum('klcd,adki,bclj->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,baki,dclj->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,bdji,aclk->abij', I.oovv, T2old, T2old)
    T2 += 1.0*einsum('klcd,bdki,aclj->abij', I.oovv, T2old, T2old)
    T2 += 0.25*einsum('klcd,dcji,balk->abij', I.oovv, T2old, T2old)
    T2 += -0.5*einsum('klcd,dcki,balj->abij', I.oovv, T2old, T2old)
    T2 += -1.0*einsum('Ikc,ak,bcji,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,bk,acji,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bakj,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,cj,ak,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,baki,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('klic,cj,bk,al->abij', I.ooov, T1old, T1old, T1old)
    T2 += 1.0*einsum('kljc,ci,bk,al->abij', I.ooov, T1old, T1old, T1old)
    T2 += -1.0*einsum('kacd,di,cj,bk->abij', I.ovvv, T1old, T1old, T1old)
    T2 += 1.0*einsum('kbcd,di,cj,ak->abij', I.ovvv, T1old, T1old, T1old)
    T2 += -1.0*einsum('klcd,ak,dl,bcji->abij', I.oovv, T1old, T1old, T2old)
    T2 += -0.5*einsum('klcd,bk,al,dcji->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,bk,dl,acji->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,di,ak,bclj->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,bk,aclj->abij', I.oovv, T1old, T1old, T2old)
    T2 += -0.5*einsum('klcd,di,cj,balk->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,ck,balj->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,dj,ak,bcli->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,dj,bk,acli->abij', I.oovv, T1old, T1old, T2old)
    T2 += -1.0*einsum('klcd,dj,ck,bali->abij', I.oovv, T1old, T1old, T2old)
    T2 += 1.0*einsum('klcd,di,cj,bk,al->abij', I.oovv, T1old, T1old, T1old, T1old)

    # Initialize and populate S1 operator
    S1 = H.copy()
    #S1 += 1.0*einsum('IJ,J->I', w, S1old)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', g.ov, T1old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # Initialize and populate S2 operator
    S2 = H.copy()
    #S2 += 1.0*einsum('IK,JK->IJ', w, S2old)
    #S2 += 1.0*einsum('JK,IK->IJ', w, S2old)
    S2 += 1.0*einsum('Iia,Jai->IJ', g.ov, U11old)
    S2 += 1.0*einsum('Jia,Iai->IJ', g.ov, U11old)
    S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
    S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
    S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)


    # Initialize and populate U11 operator
    U11 = h.vo.copy()
    U11 += 1.0*einsum('Iai->Iai', g.vo)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old)
    U11 += -1.0*einsum('Iji,aj->Iai', g.oo, T1old)
    U11 += 1.0*einsum('Iab,bi->Iai', g.vv, T1old)
    U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
    U11 += -1.0*einsum('Ijb,abji->Iai', g.ov, T2old)
    U11 += -1.0*einsum('jaib,Ibj->Iai', I.ovov, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', g.ov, T1old, T1old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += 1.0*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,abji,IJ->Iai', g.ov, T2old, S2old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jabc,ci,Ibj->Iai', I.ovvv, T1old, U11old)
    U11 += -1.0*einsum('jabc,cj,Ibi->Iai', I.ovvv, T1old, U11old)
    U11 += 1.0*einsum('jkbc,acji,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += 0.5*einsum('jkbc,ackj,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += 0.5*einsum('jkbc,cbji,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)

    return T1, T2, S1, S2, U11


def qed_ccsd_sn_u1n_gen(F, I, w, g, h, G, H, nfock1, nfock2, amps):
    '''
    nfock1 -- order of Sn operator
    nfock2 -- order of U1n operator
    '''
    T1old, T2old, Snold, U1nold = amps
    Sn = [None]*nfock1
    U1n = [None]*nfock2

    #epcc_opt is QED-CCSD_S1_U11,
    #T1, T2, Sn[0], U1n[0] = epcc_opt(F, I, w, g, h, G, H, T1old, T2old, Snold[0], U1nold[0])

    S1old = Snold[0]
    U11old = U1nold[0]

    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # T1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # T2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    #T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    #T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    #T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    #T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1 equation
    S1 = H.copy()
    #S1 += 1.0*einsum('I,I->I', w, S1old)
    
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    #U11 += 1.0*einsum('I,Iai->Iai', w, U11old)
    
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)
    
    Sn[0] = S1
    U1n[0] = U11
    
    np = w.shape[0]
    w2d = numpy.zeros((np,np))
    for k in range(np):
        w2d[k,k] = w[k]

    if nfock1 > 1:
        # add nfock == 2 term
        
        S2old = Snold[1]
        # S1
        Sn[0] += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
        
        # S2
        Sn[1] = numpy.zeros((w.shape[0],w.shape[0]))
        S2 = Sn[1]

        S2 += 1.0*einsum('IK,JK->IJ', w2d, S2old)
        S2 += 1.0*einsum('JK,IK->IJ', w2d, S2old)
        
        S2 += 1.0*einsum('Iia,Jai->IJ', g.ov, U11old)
        S2 += 1.0*einsum('Jia,Iai->IJ', g.ov, U11old)
        S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
        S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
        S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)
        
        U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
        U11 += -0.5*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
        U11 += 0.5*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
        U11 += -0.5*einsum('Jjb,abji,IJ->Iai', g.ov, T2old, S2old)
        U11 += -0.3333333333333333*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)

    if nfock1 > 2:
        # add nfock == 3 term (difference from nfock == 2, no double counting terms)
        Sn[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0]))
        S3 = Sn[2]
        S3old = Snold[2]

        S2 += 0.3333333333333333*einsum('Kia,ai,IJK->IJ', g.ov, T1old, S3old)
        S2 += 0.3333333333333333*einsum('Kia,ai,IKJ->IJ', g.ov, T1old, S3old)
        S2 += 0.16666666666666666*einsum('Kia,ai,JKI->IJ', g.ov, T1old, S3old)
        S2 += 0.16666666666666666*einsum('Kia,ai,KJI->IJ', g.ov, T1old, S3old)
        #S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)
        
        S3 += 0.33333333333333333*einsum('IL,JKL->IJK', w2d, S3old)
        S3 += 0.33333333333333333*einsum('IL,JLK->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('IL,KLJ->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('IL,LKJ->IJK', w2d, S3old)
        S3 += 0.33333333333333333*einsum('JL,IKL->IJK', w2d, S3old)
        S3 += 0.33333333333333333*einsum('JL,ILK->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('JL,KLI->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('JL,LKI->IJK', w2d, S3old)
        S3 += 0.33333333333333333*einsum('KL,IJL->IJK', w2d, S3old)
        S3 += 0.33333333333333333*einsum('KL,ILJ->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('KL,JLI->IJK', w2d, S3old)
        S3 += 0.16666666666666666*einsum('KL,LJI->IJK', w2d, S3old)
        
        S3 += 0.33333333333333333*einsum('Lia,IJL,Kai->IJK', g.ov, S3old, U11old)
        S3 += 0.33333333333333333*einsum('Lia,IKL,Jai->IJK', g.ov, S3old, U11old)
        S3 += 0.33333333333333333*einsum('Lia,ILJ,Kai->IJK', g.ov, S3old, U11old)
        S3 += 0.33333333333333333*einsum('Lia,ILK,Jai->IJK', g.ov, S3old, U11old)
        S3 += 0.33333333333333333*einsum('Lia,JKL,Iai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,JLI,Kai->IJK', g.ov, S3old, U11old)
        S3 += 0.33333333333333333*einsum('Lia,JLK,Iai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,KLI,Jai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,KLJ,Iai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,LJI,Kai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,LKI,Jai->IJK', g.ov, S3old, U11old)
        S3 += 0.16666666666666666*einsum('Lia,LKJ,Iai->IJK', g.ov, S3old, U11old)
    
    if nfock1 > 3:
        # add nfock == 4 term
        Sn[3] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S4 = Sn[3]
        S4old = Snold[3]

        S3 += 0.08333333333333333*einsum('Lia,ai,IJKL->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,IJLK->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,IKJL->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,IKLJ->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,ILJK->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,ILKJ->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,JKIL->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,JLIK->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,KJIL->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,KLIJ->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,LJIK->IJK', g.ov, T1old, S4old)
        S3 += 0.08333333333333333*einsum('Lia,ai,LKIJ->IJK', g.ov, T1old, S4old)
        
        S4 += 0.08333333333333333*einsum('IM,JKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JLMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,JMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KLJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,KMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,LMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MKJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('IM,MLJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IKML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,ILMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMKL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,IMLK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,KMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,LMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MKIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('JM,MLIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJLM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IJML->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,ILMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMJL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,IMLJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JLIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,JMIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,LMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MJIL->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('KM,MLIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJKM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IJMK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKJM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IKMJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMJK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,IMKJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JKIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,JMIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KJIM->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,KMIJ->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MJIK->IJKL', w2d, S4old)
        S4 += 0.08333333333333333*einsum('LM,MKIJ->IJKL', w2d, S4old)

        S4 += 0.08333333333333333*einsum('Mia,IJKM,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IJLM,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IJMK,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IJML,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IKJM,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IKLM,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IKMJ,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IKML,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,ILJM,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,ILKM,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,ILMJ,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,ILMK,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMJK,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMJL,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMKJ,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMKL,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMLJ,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,IMLK,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JKIM,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JKLM,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JKML,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JLIM,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JLKM,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JLMK,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JMIK,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JMIL,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JMKL,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,JMLK,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KJIM,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KLIM,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KLJM,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KMIJ,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KMIL,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,KMJL,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LJIM,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LKIM,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LKJM,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LMIJ,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LMIK,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,LMJK,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MJIK,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MJIL,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MKIJ,Lai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MKIL,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MKJL,Iai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MLIJ,Kai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MLIK,Jai->IJKL', g.ov, S4old, U11old)
        S4 += 0.08333333333333333*einsum('Mia,MLJK,Iai->IJKL', g.ov, S4old, U11old)

    if nfock1 > 4:
        # add nfock == 5 term
        Sn[4] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0],w.shape[0],w.shape[0]))
        S5 = Sn[4]
        S5old = Snold[4]

        S4 += 0.016666666666666666*einsum('Mia,ai,IJKLM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IJKML->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IJLKM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IJLMK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IJMKL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IJMLK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKJLM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKJML->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKLJM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKLMJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKMJL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IKMLJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILJKM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILJMK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILKJM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILKMJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILMJK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,ILMKJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMJKL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMJLK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMKJL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMKLJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMLJK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,IMLKJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JKILM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JKIML->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JKLMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JKMLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JLIKM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JLIMK->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JLKMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JLMKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JMIKL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,JMILK->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JMKLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,JMLKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KJILM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KJIML->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KJLMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KJMLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KLIJM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KLIMJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KLJMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KLMJI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KMIJL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,KMILJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KMJLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,KMLJI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LJIKM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LJIMK->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LJKMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LJMKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LKIJM->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LKIMJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LKJMI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LKMJI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LMIJK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,LMIKJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LMJKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,LMKJI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MJIKL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MJILK->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MJKLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MJLKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MKIJL->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MKILJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MKJLI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MKLJI->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MLIJK->IJKL', g.ov, T1old, S5old)
        S4 += 0.016666666666666666*einsum('Mia,ai,MLIKJ->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MLJKI->IJKL', g.ov, T1old, S5old)
        S4 += 0.008333333333333333*einsum('Mia,ai,MLKJI->IJKL', g.ov, T1old, S5old)
        
        S5 += 0.016666666666666666*einsum('IN,JKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JLNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,JNMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KLJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KLNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KMJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,KNJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,KNMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LKJNM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKMNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LMJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,LNJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,LNMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MKJNL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKLNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MLJNK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLKNJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MLNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,MNJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,MNLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NKJML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKLMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NKMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NLJMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLKMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NLMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('IN,NMJLK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMKLJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('IN,NMLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IKNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,ILNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,IMNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INKML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INLMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,INMLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,KNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,KNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,LNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,LNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,MNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,MNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NKIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NKMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NLIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NLMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('JN,NMILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('JN,NMLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJLNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJMNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IJNML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,ILNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,IMNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJLM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INJML->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INLMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,INMLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JLINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JLNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JMINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JMNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,JNIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,JNMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,LNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,LNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,MNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,MNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJILM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NJIML->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJLMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NJMLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NLIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NLMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('KN,NMILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('KN,NMLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJKNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJMNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IJNMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKJNM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKMNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IKNMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,IMNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INJMK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INKMJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,INMKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JKINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JKNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JMINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JMNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,JNIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,JNMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJIMN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KJINM->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJMNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KJNMI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KMINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KMNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,KNIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,KNMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,MNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,MNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIKM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NJIMK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJKMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NJMKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIJM->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NKIMJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKJMI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NKMJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('LN,NMIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('LN,NMKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJKNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJLNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IJNLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJLN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKJNL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKLNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,IKNLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILJNK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILKNJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,ILNKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INJLK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INKLJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,INLKJ->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JKINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JKNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JLINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JLNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,JNILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,JNLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJILN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KJINL->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJLNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KJNLI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KLINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KLNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,KNILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,KNLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJIKN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LJINK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJKNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LJNKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKIJN->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LKINJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKJNI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LKNJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,LNIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,LNKJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJIKL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NJILK->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJKLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NJLKI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKIJL->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NKILJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKJLI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NKLJI->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIJK->IJKLM', w2d, S5old)
        S5 += 0.016666666666666666*einsum('MN,NLIKJ->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLJKI->IJKLM', w2d, S5old)
        S5 += 0.008333333333333333*einsum('MN,NLKJI->IJKLM', w2d, S5old)
        
        S5 += 0.016666666666666666*einsum('Nia,IJKLN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJKMN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJKNL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJKNM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJLKN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJLMN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJLNK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJLNM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJMKN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJMLN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJMNK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJMNL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNKL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNKM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNLK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNLM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNMK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IJNML,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKJLN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKJMN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKJNL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKJNM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKLJN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKLMN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKLNJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKLNM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKMJN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKMLN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKMNJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKMNL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNJL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNJM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNLJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNLM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNMJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IKNML,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILJKN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILJMN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILJNK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILJNM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILKJN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILKMN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILKNJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILKNM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILMJN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILMKN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILMNJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILMNK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNJK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNJM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNKJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNKM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNMJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,ILNMK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMJKN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMJLN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMJNK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMJNL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMKJN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMKLN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMKNJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMKNL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMLJN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMLKN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMLNJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMLNK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNJK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNJL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNKJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNKL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNLJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,IMNLK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJKL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJKM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJLK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJLM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJMK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INJML,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKJL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKJM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKLJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKLM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKMJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INKML,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLJK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLJM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLKJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLKM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLMJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INLMK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMJK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMJL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMKJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMKL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMLJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,INMLK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKILN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKIMN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKINL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKINM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKLMN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JKLNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKLNM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKMLN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JKMNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKMNL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JKNLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKNLM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JKNMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JKNML,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLIKN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLIMN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLINK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLINM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLKMN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JLKNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLKNM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLMKN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JLMNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLMNK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JLNKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLNKM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JLNMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JLNMK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMIKN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMILN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMINK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMINL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMKLN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JMKNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMKNL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMLKN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JMLNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMLNK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JMNKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMNKL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JMNLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JMNLK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNIKL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNIKM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNILK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNILM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNIMK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNIML,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNKLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNKLM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNKMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNKML,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNLKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNLKM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNLMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNLMK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNMKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNMKL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,JNMLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,JNMLK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KJILN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KJIMN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KJINL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KJINM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KJLNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KJMNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KJNLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KJNMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLIJN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLIMN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLINJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLINM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLJMN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLJNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KLJNM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLMNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLMNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLNJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLNMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KLNMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMIJN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMILN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMINJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMINL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMJLN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMJNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KMJNL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMLNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMLNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMNJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMNLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KMNLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNIJL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNIJM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNILJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNILM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNIMJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNIML,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNJLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNJLM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNJMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,KNJML,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNLJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNLMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNLMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNMJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNMLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,KNMLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LJIKN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LJIMN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LJINK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LJINM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LJKNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LJMNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LJNKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LJNMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKIJN,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKIMN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKINJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKINM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKJMN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKJNI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LKJNM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKMNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKMNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKNJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKNMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LKNMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMIJN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMIKN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMINJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMINK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMJKN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMJNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LMJNK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMKNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMKNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMNJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMNKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LMNKJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIJK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIJM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIKJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIKM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIMJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNIMK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNJKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNJKM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNJMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,LNJMK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNKJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNKMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNKMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNMJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNMKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,LNMKJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MJIKN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MJILN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MJINK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MJINL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MJKNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MJLNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MJNKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MJNLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKIJN,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKILN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKINJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKINL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKJLN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKJNI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MKJNL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKLNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKLNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKNJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKNLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MKNLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLIJN,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLIKN,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLINJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLINK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLJKN,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLJNI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MLJNK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLKNI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLKNJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLNJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLNKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MLNKJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNIJK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNIJL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNIKJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNIKL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNILJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNILK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNJKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNJKL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNJLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,MNJLK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNKJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNKLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNKLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNLJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNLKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,MNLKJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJIKL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJIKM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJILK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJILM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJIMK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NJIML,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJKLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJKMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJLKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJLMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJMKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NJMLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKIJL,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKIJM,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKILJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKILM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKIMJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKIML,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKJLI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKJLM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKJMI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NKJML,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKLJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKLMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKLMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKMJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKMLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NKMLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIJK,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIJM,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIKJ,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIKM,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIMJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLIMK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLJKI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLJKM,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLJMI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NLJMK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLKJI,Mai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLKMI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLKMJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLMJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLMKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NLMKJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMIJK,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMIJL,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMIKJ,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMIKL,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMILJ,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMILK,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMJKI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMJKL,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMJLI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.016666666666666666*einsum('Nia,NMJLK,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMKJI,Lai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMKLI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMKLJ,Iai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMLJI,Kai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMLKI,Jai->IJKLM', g.ov, S5old, U11old)
        S5 += 0.008333333333333333*einsum('Nia,NMLKJ,Iai->IJKLM', g.ov, S5old, U11old)

    # order of photonic excition in the coupled electron-photon excitation (U1n)
    # here the electron excitation in U keeps at the 1st order
    if nfock2 > 1:
        # add nfock == 2 term
        print('add U12 components (TBD)')

    if nfock2 > 2:
        # add nfock == 3 term
        print('add U13 components (TBD)')
    if nfock2 > 3:
        # add nfock == 4 term
        print('add U14 components (TBD)')

    return T1, T2, Sn, U1n

def qed_ccsd_sn_u12_gen(F, I, w, g, h, G, H, nfock1, nfock2, amps):

    '''
    nfock1 -- order of Sn operator
    nfock2 -- order of U1n operator
    '''
    T1old, T2old, Snold, U1nold = amps
    Sn = [None]*nfock1
    U1n = [None]*nfock2

    #epcc_opt is QED-CCSD_S1_U11,
    #T1, T2, Sn[0], U1n[0] = epcc_opt(F, I, w, g, h, G, H, T1old, T2old, Snold[0], U1nold[0])

    S1old = Snold[0]
    S2old = Snold[1]

    U11old = U1nold[0]
    U12old = U1nold[1]
    
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # copy of the epcc2_12_gen
    # F1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # F2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1
    S1 = H.copy()
    #S1 += 1.0*einsum('I->I', H)
    #S1 += 1.0*einsum('IJ,J->I', w, S1old)
    S1 += 1.0*einsum('J,IJ->I', G, S2old)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,IJai->I', g.ov, U12old)
    S1 += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    Sn[0] = S1

    # S2
    nm = S1.shape[0]
    Sn[1] = numpy.zeros((nm, nm))
    S2 = Sn[1]
    
    #S2 += 1.0*einsum('IK,JK->IJ', w, S2old)
    #S2 += 1.0*einsum('JK,IK->IJ', w, S2old)
    S2 += 1.0*einsum('ia,IJai->IJ', F.ov, U12old)
    S2 += 1.0*einsum('Iia,Jai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Jia,Iai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Kia,K,IJai->IJ', g.ov, S1old, U12old)
    S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
    S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
    S2 += -1.0*einsum('ijab,bi,IJaj->IJ', I.oovv, T1old, U12old)
    S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

    # U11 equations
    U11 = h.vo.copy()
    #U11 += 1.0*einsum('Iai->Iai', h)
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    #U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old)
    U11 += 1.0*einsum('J,IJai->Iai', G, U12old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += -1.0*einsum('Jji,IJaj->Iai', g.oo, U12old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += 1.0*einsum('Jab,IJbi->Iai', g.vv, U12old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,IJaj->Iai', g.ov, T1old, U12old)
    U11 += -1.0*einsum('Jjb,aj,IJbi->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,bj,IJai->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,abij,IJ->Iai', g.ov, T2old, S2old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)

    # U12 equations
    nv,no = T1.shape
    U12 = numpy.zeros((nm, nm, nv, no))
    U12 += -1.0*einsum('ji,IJaj->IJai', F.oo, U12old)
    U12 += 1.0*einsum('ab,IJbi->IJai', F.vv, U12old)
    #U12 += 1.0*einsum('IK,JKai->IJai', w, U12old)
    #U12 += 1.0*einsum('JK,IKai->IJai', w, U12old)
    U12 += -1.0*einsum('Iji,Jaj->IJai', h.oo, U11old)
    U12 += -1.0*einsum('Jji,Iaj->IJai', h.oo, U11old)
    U12 += 1.0*einsum('Iab,Jbi->IJai', h.vv, U11old)
    U12 += 1.0*einsum('Jab,Ibi->IJai', h.vv, U11old)
    U12 += -1.0*einsum('ajbi,IJbj->IJai', I.vovo, U12old)
    U12 += -1.0*einsum('jb,bi,IJaj->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,aj,IJbi->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,Ibi,Jaj->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('jb,Iaj,Jbi->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('Kji,K,IJaj->IJai', g.oo, S1old, U12old)
    U12 += -1.0*einsum('Kji,IK,Jaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Kji,JK,Iaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Ijb,bi,Jaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Ijb,aj,Jbi->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,bi,Iaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,aj,Ibi->IJai', h.ov, T1old, U11old)
    U12 += 1.0*einsum('Kab,K,IJbi->IJai', g.vv, S1old, U12old)
    U12 += 1.0*einsum('Kab,IK,Jbi->IJai', g.vv, S2old, U11old)
    U12 += 1.0*einsum('Kab,JK,Ibi->IJai', g.vv, S2old, U11old)
    U12 += -1.0*einsum('jkib,aj,IJbk->IJai', I.ooov, T1old, U12old)
    U12 += 1.0*einsum('jkib,bj,IJak->IJai', I.ooov, T1old, U12old)
    U12 += -1.0*einsum('jkib,Iaj,Jbk->IJai', I.ooov, U11old, U11old)
    U12 += 1.0*einsum('jkib,Ibj,Jak->IJai', I.ooov, U11old, U11old)
    U12 += -1.0*einsum('ajbc,ci,IJbj->IJai', I.vovv, T1old, U12old)
    U12 += 1.0*einsum('ajbc,cj,IJbi->IJai', I.vovv, T1old, U12old)
    U12 += -1.0*einsum('ajbc,Ici,Jbj->IJai', I.vovv, U11old, U11old)
    U12 += 1.0*einsum('ajbc,Icj,Jbi->IJai', I.vovv, U11old, U11old)
    U12 += -1.0*einsum('Kjb,Ibi,JKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Iaj,JKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Ibj,JKai->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jbi,IKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jaj,IKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Jbj,IKai->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Kai,IJbj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kbi,IJaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kaj,IJbi->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('jkbc,acij,IJbk->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,cbij,IJak->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,acjk,IJbi->IJai', I.oovv, T2old, U12old)
    U12 += -1.0*einsum('Kjb,bi,K,IJaj->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,aj,K,IJbi->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,bi,IK,Jaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,IK,Jbi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,bi,JK,Iaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,JK,Ibi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,K,Ibi,Jaj->IJai', g.ov, S1old, U11old, U11old)
    U12 += -1.0*einsum('Kjb,K,Iaj,Jbi->IJai', g.ov, S1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,ci,aj,IJbk->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,ci,bj,IJak->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,aj,ck,IJbi->IJai', I.oovv, T1old, T1old, U12old)
    U12 += 1.0*einsum('jkbc,ci,Iaj,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,ci,Ibj,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,aj,Ici,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Ibi,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,aj,Ick,Jbi->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Iak,Jbi->IJai', I.oovv, T1old, U11old, U11old)

    # end of the copy

    if nfock1 > 2:
        # add nfock == 3 term (difference from nfock == 2, no double counting terms)
        # 3_u12 case, take the difference between 3_u12 and 2_u12 (diff32_u12.log)

        Sn[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0]))
        S3 = Sn[2]
        S3old = Snold[2]

        Sn[1] += 0.3333333333333333*einsum('Kia,ai,IJK->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.3333333333333333*einsum('Kia,ai,IKJ->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,ai,JKI->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,ai,KJI->IJ', g.ov, T1old, Snold[2])

        Sn[2] += 0.3333333333333333*einsum('IL,JKL->IJK', w, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('IL,JLK->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('IL,KLJ->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('IL,LKJ->IJK', w, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('JL,IKL->IJK', w, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('JL,ILK->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('JL,KLI->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('JL,LKI->IJK', w, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('KL,IJL->IJK', w, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('KL,ILJ->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('KL,JLI->IJK', w, Snold[2])
        Sn[2] += 0.16666666666666666*einsum('KL,LJI->IJK', w, Snold[2])
        Sn[2] += 1.0*einsum('Iia,JKai->IJK', g.ov, U1nold[1])
        Sn[2] += 1.0*einsum('Jia,IKai->IJK', g.ov, U1nold[1])
        Sn[2] += 1.0*einsum('Kia,IJai->IJK', g.ov, U1nold[1])
        Sn[2] += 1.0*einsum('Lia,IL,JKai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 1.0*einsum('Lia,JL,IKai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 1.0*einsum('Lia,KL,IJai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 0.3333333333333333*einsum('Lia,IJL,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,IKL,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,ILJ,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,ILK,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,JKL,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,JLI,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,JLK,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,KLI,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,KLJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LJI,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LKI,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LKJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += -1.0*einsum('ijab,Ibi,JKaj->IJK', I.oovv, U1nold[0], U1nold[1])
        Sn[2] += -1.0*einsum('ijab,Jbi,IKaj->IJK', I.oovv, U1nold[0], U1nold[1])
        Sn[2] += -1.0*einsum('ijab,Kbi,IJaj->IJK', I.oovv, U1nold[0], U1nold[1])

        U1n[1] += 0.3333333333333333*einsum('Kai,IJK->IJai', g.vo, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kai,IKJ->IJai', g.vo, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kai,JKI->IJai', g.vo, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kai,KJI->IJai', g.vo, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,aj,IJK->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,aj,IKJ->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,aj,JKI->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,aj,KJI->IJai', g.oo, T1old, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,bi,IJK->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,bi,IKJ->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,bi,JKI->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,bi,KJI->IJai', g.vv, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IJK->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IKJ->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,abji,JKI->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,abji,KJI->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IJK->IJai', g.ov, T1old, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IKJ->IJai', g.ov, T1old, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,bi,aj,JKI->IJai', g.ov, T1old, T1old, Snold[2])

    if nfock1 > 3:
        # 4_u12 case, take the difference between 4_u12 and 3_u12 (diff43_u12.log)
        print('case 4_u12 TBA')

    return T1, T2, Sn, U1n

def qed_ccsd_sn_u1n_gen_equal(F, I, w, g, h, G, H, nfock, amps):

    '''
    nfock1 -- order of Sn operator
    nfock2 -- order of U1n operator
    nfock1 = nfock2 = nfock >= 2
    '''
    #print('test-zy: in u1n_gen_equal')
    T1old, T2old, Snold, U1nold = amps

    Sn = [None]*nfock
    U1n = [None]*nfock

    #epcc_opt is QED-CCSD_S1_U11,
    #T1, T2, Sn[0], U1n[0] = epcc_opt(F, I, w, g, h, G, H, T1old, T2old, Snold[0], U1nold[0])

    S1old = Snold[0]
    S2old = Snold[1]
    
    U11old = U1nold[0]
    U12old = U1nold[1]
    
    T1,T2 = cc_equations.ccsd_simple(F, I, T1old, T2old)

    # copy of the epcc2_12_gen
    # F1
    T1 += 1.0*einsum('I,Iai->ai', G, U11old)
    T1 += 1.0*einsum('Iai,I->ai', g.vo, S1old)
    T1 += -1.0*einsum('Iji,Iaj->ai', g.oo, U11old)
    T1 += 1.0*einsum('Iab,Ibi->ai', g.vv, U11old)
    T1 += -1.0*einsum('Iji,aj,I->ai', g.oo, T1old, S1old)
    T1 += 1.0*einsum('Iab,bi,I->ai', g.vv, T1old, S1old)
    T1 += -1.0*einsum('Ijb,bi,Iaj->ai', g.ov, T1old, U11old)
    T1 += -1.0*einsum('Ijb,aj,Ibi->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,bj,Iai->ai', g.ov, T1old, U11old)
    T1 += 1.0*einsum('Ijb,abij,I->ai', g.ov, T2old, S1old)
    T1 += -1.0*einsum('Ijb,bi,aj,I->ai', g.ov, T1old, T1old, S1old)

    # F2
    T2 += 1.0*einsum('Iai,Ibj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Ibi,Iaj->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iaj,Ibi->abij', g.vo, U11old)
    T2 += 1.0*einsum('Ibj,Iai->abij', g.vo, U11old)
    T2 += -1.0*einsum('Iki,ak,Ibj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,bk,Iaj->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Ikj,ak,Ibi->abij', g.oo, T1old, U11old)
    T2 += -1.0*einsum('Ikj,bk,Iai->abij', g.oo, T1old, U11old)
    T2 += 1.0*einsum('Iki,abjk,I->abij', g.oo, T2old, S1old)
    T2 += -1.0*einsum('Ikj,abik,I->abij', g.oo, T2old, S1old)
    T2 += 1.0*einsum('Iac,ci,Ibj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Ibc,ci,Iaj->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,cj,Ibi->abij', g.vv, T1old, U11old)
    T2 += 1.0*einsum('Ibc,cj,Iai->abij', g.vv, T1old, U11old)
    T2 += -1.0*einsum('Iac,bcij,I->abij', g.vv, T2old, S1old)
    T2 += 1.0*einsum('Ibc,acij,I->abij', g.vv, T2old, S1old)
    T2 += -1.0*einsum('Ikc,acij,Ibk->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,abik,Icj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,acik,Ibj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcij,Iak->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,bcik,Iaj->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,abjk,Ici->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,acjk,Ibi->abij', g.ov, T2old, U11old)
    T2 += 1.0*einsum('Ikc,bcjk,Iai->abij', g.ov, T2old, U11old)
    T2 += -1.0*einsum('Ikc,ci,ak,Ibj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,bk,Iaj->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ak,cj,Ibi->abij', g.ov, T1old, T1old, U11old)
    T2 += -1.0*einsum('Ikc,cj,bk,Iai->abij', g.ov, T1old, T1old, U11old)
    T2 += 1.0*einsum('Ikc,ci,abjk,I->abij', g.ov, T1old, T2old, S1old)
    T2 += 1.0*einsum('Ikc,ak,bcij,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,cj,abik,I->abij', g.ov, T1old, T2old, S1old)
    T2 += -1.0*einsum('Ikc,bk,acij,I->abij', g.ov, T1old, T2old, S1old)

    # S1
    S1 = H.copy()
    #S1 += 1.0*einsum('I->I', H)
    #S1 += 1.0*einsum('IJ,J->I', w, S1old)
    S1 += 1.0*einsum('J,IJ->I', G, S2old)
    S1 += 1.0*einsum('ia,Iai->I', F.ov, U11old)
    S1 += 1.0*einsum('Iia,ai->I', h.ov, T1old)
    S1 += 1.0*einsum('Jia,IJai->I', g.ov, U12old)
    S1 += 1.0*einsum('Jia,ai,IJ->I', g.ov, T1old, S2old)
    S1 += 1.0*einsum('Jia,J,Iai->I', g.ov, S1old, U11old)
    S1 += -1.0*einsum('ijab,bi,Iaj->I', I.oovv, T1old, U11old)

    # S2
    nm = S1.shape[0]
    S2 = numpy.zeros((nm,nm))
    #S2 += 1.0*einsum('IK,JK->IJ', w, S2old)
    #S2 += 1.0*einsum('JK,IK->IJ', w, S2old)
    S2 += 1.0*einsum('ia,IJai->IJ', F.ov, U12old)
    S2 += 1.0*einsum('Iia,Jai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Jia,Iai->IJ', h.ov, U11old)
    S2 += 1.0*einsum('Kia,K,IJai->IJ', g.ov, S1old, U12old)
    S2 += 1.0*einsum('Kia,IK,Jai->IJ', g.ov, S2old, U11old)
    S2 += 1.0*einsum('Kia,JK,Iai->IJ', g.ov, S2old, U11old)
    S2 += -1.0*einsum('ijab,bi,IJaj->IJ', I.oovv, T1old, U12old)
    S2 += -1.0*einsum('ijab,Ibi,Jaj->IJ', I.oovv, U11old, U11old)

    # U11 equations
    #U11 += 1.0*einsum('Iai->Iai', h)
    U11 = h.vo.copy()
    U11 += -1.0*einsum('ji,Iaj->Iai', F.oo, U11old)
    U11 += 1.0*einsum('ab,Ibi->Iai', F.vv, U11old)
    #U11 += 1.0*einsum('IJ,Jai->Iai', w, U11old)
    #U11 += 1.0*einsum('J,IJai->Iai', G, U12old)
    U11 += -1.0*einsum('Iji,aj->Iai', h.oo, T1old)
    U11 += 1.0*einsum('Jai,IJ->Iai', g.vo, S2old)
    U11 += 1.0*einsum('Iab,bi->Iai', h.vv, T1old)
    U11 += -1.0*einsum('ajbi,Ibj->Iai', I.vovo, U11old)
    U11 += -1.0*einsum('Jji,IJaj->Iai', g.oo, U12old)
    U11 += 1.0*einsum('Ijb,abij->Iai', h.ov, T2old)
    U11 += 1.0*einsum('Jab,IJbi->Iai', g.vv, U12old)
    U11 += -1.0*einsum('jb,bi,Iaj->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('jb,aj,Ibi->Iai', F.ov, T1old, U11old)
    U11 += -1.0*einsum('Jji,aj,IJ->Iai', g.oo, T1old, S2old)
    U11 += -1.0*einsum('Jji,J,Iaj->Iai', g.oo, S1old, U11old)
    U11 += -1.0*einsum('Ijb,bi,aj->Iai', h.ov, T1old, T1old)
    U11 += 1.0*einsum('Jab,bi,IJ->Iai', g.vv, T1old, S2old)
    U11 += 1.0*einsum('Jab,J,Ibi->Iai', g.vv, S1old, U11old)
    U11 += -1.0*einsum('jkib,aj,Ibk->Iai', I.ooov, T1old, U11old)
    U11 += 1.0*einsum('jkib,bj,Iak->Iai', I.ooov, T1old, U11old)
    U11 += -1.0*einsum('ajbc,ci,Ibj->Iai', I.vovv, T1old, U11old)
    U11 += 1.0*einsum('ajbc,cj,Ibi->Iai', I.vovv, T1old, U11old)
    U11 += -1.0*einsum('Jjb,bi,IJaj->Iai', g.ov, T1old, U12old)
    U11 += -1.0*einsum('Jjb,aj,IJbi->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,bj,IJai->Iai', g.ov, T1old, U12old)
    U11 += 1.0*einsum('Jjb,abij,IJ->Iai', g.ov, T2old, S2old)
    U11 += -1.0*einsum('Jjb,Ibi,Jaj->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('Jjb,Iaj,Jbi->Iai', g.ov, U11old, U11old)
    U11 += 1.0*einsum('Jjb,Ibj,Jai->Iai', g.ov, U11old, U11old)
    U11 += -1.0*einsum('jkbc,acij,Ibk->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,cbij,Iak->Iai', I.oovv, T2old, U11old)
    U11 += -0.5*einsum('jkbc,acjk,Ibi->Iai', I.oovv, T2old, U11old)
    U11 += -1.0*einsum('Jjb,bi,aj,IJ->Iai', g.ov, T1old, T1old, S2old)
    U11 += -1.0*einsum('Jjb,bi,J,Iaj->Iai', g.ov, T1old, S1old, U11old)
    U11 += -1.0*einsum('Jjb,aj,J,Ibi->Iai', g.ov, T1old, S1old, U11old)
    U11 += 1.0*einsum('jkbc,ci,aj,Ibk->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,ci,bj,Iak->Iai', I.oovv, T1old, T1old, U11old)
    U11 += -1.0*einsum('jkbc,aj,ck,Ibi->Iai', I.oovv, T1old, T1old, U11old)

    # U12 equations
    nv,no = T1.shape
    U12 = numpy.zeros((nm, nm, nv, no))
    
    U12 += -1.0*einsum('ji,IJaj->IJai', F.oo, U12old)
    U12 +=  1.0*einsum('ab,IJbi->IJai', F.vv, U12old)
    #U12 += 1.0*einsum('IK,JKai->IJai', w, U12old)
    #U12 += 1.0*einsum('JK,IKai->IJai', w, U12old)
    U12 += -1.0*einsum('Iji,Jaj->IJai', h.oo, U11old)
    U12 += -1.0*einsum('Jji,Iaj->IJai', h.oo, U11old)
    U12 += 1.0*einsum('Iab,Jbi->IJai', h.vv, U11old)
    U12 += 1.0*einsum('Jab,Ibi->IJai', h.vv, U11old)
    U12 += -1.0*einsum('ajbi,IJbj->IJai', I.vovo, U12old)
    U12 += -1.0*einsum('jb,bi,IJaj->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,aj,IJbi->IJai', F.ov, T1old, U12old)
    U12 += -1.0*einsum('jb,Ibi,Jaj->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('jb,Iaj,Jbi->IJai', F.ov, U11old, U11old)
    U12 += -1.0*einsum('Kji,K,IJaj->IJai', g.oo, S1old, U12old)
    U12 += -1.0*einsum('Kji,IK,Jaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Kji,JK,Iaj->IJai', g.oo, S2old, U11old)
    U12 += -1.0*einsum('Ijb,bi,Jaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Ijb,aj,Jbi->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,bi,Iaj->IJai', h.ov, T1old, U11old)
    U12 += -1.0*einsum('Jjb,aj,Ibi->IJai', h.ov, T1old, U11old)
    U12 += 1.0*einsum('Kab,K,IJbi->IJai', g.vv, S1old, U12old)
    U12 += 1.0*einsum('Kab,IK,Jbi->IJai', g.vv, S2old, U11old)
    U12 += 1.0*einsum('Kab,JK,Ibi->IJai', g.vv, S2old, U11old)
    U12 += -1.0*einsum('jkib,aj,IJbk->IJai', I.ooov, T1old, U12old)
    U12 += 1.0*einsum('jkib,bj,IJak->IJai', I.ooov, T1old, U12old)
    U12 += -1.0*einsum('jkib,Iaj,Jbk->IJai', I.ooov, U11old, U11old)
    U12 += 1.0*einsum('jkib,Ibj,Jak->IJai', I.ooov, U11old, U11old)
    U12 += -1.0*einsum('ajbc,ci,IJbj->IJai', I.vovv, T1old, U12old)
    U12 += 1.0*einsum('ajbc,cj,IJbi->IJai', I.vovv, T1old, U12old)
    U12 += -1.0*einsum('ajbc,Ici,Jbj->IJai', I.vovv, U11old, U11old)
    U12 += 1.0*einsum('ajbc,Icj,Jbi->IJai', I.vovv, U11old, U11old)
    U12 += -1.0*einsum('Kjb,Ibi,JKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Iaj,JKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Ibj,JKai->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jbi,IKaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Jaj,IKbi->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Jbj,IKai->IJai', g.ov, U11old, U12old)
    U12 += 1.0*einsum('Kjb,Kai,IJbj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kbi,IJaj->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('Kjb,Kaj,IJbi->IJai', g.ov, U11old, U12old)
    U12 += -1.0*einsum('jkbc,acij,IJbk->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,cbij,IJak->IJai', I.oovv, T2old, U12old)
    U12 += -0.5*einsum('jkbc,acjk,IJbi->IJai', I.oovv, T2old, U12old)
    U12 += -1.0*einsum('Kjb,bi,K,IJaj->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,aj,K,IJbi->IJai', g.ov, T1old, S1old, U12old)
    U12 += -1.0*einsum('Kjb,bi,IK,Jaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,IK,Jbi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,bi,JK,Iaj->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,aj,JK,Ibi->IJai', g.ov, T1old, S2old, U11old)
    U12 += -1.0*einsum('Kjb,K,Ibi,Jaj->IJai', g.ov, S1old, U11old, U11old)
    U12 += -1.0*einsum('Kjb,K,Iaj,Jbi->IJai', g.ov, S1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,ci,aj,IJbk->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,ci,bj,IJak->IJai', I.oovv, T1old, T1old, U12old)
    U12 += -1.0*einsum('jkbc,aj,ck,IJbi->IJai', I.oovv, T1old, T1old, U12old)
    U12 += 1.0*einsum('jkbc,ci,Iaj,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,ci,Ibj,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,aj,Ici,Jbk->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Ibi,Jak->IJai', I.oovv, T1old, U11old, U11old)
    U12 += -1.0*einsum('jkbc,aj,Ick,Jbi->IJai', I.oovv, T1old, U11old, U11old)
    U12 += 1.0*einsum('jkbc,cj,Iak,Jbi->IJai', I.oovv, T1old, U11old, U11old)

    Sn[0] = S1
    Sn[1] = S2

    U1n[0] = U11
    U1n[1] = U12

    np = w.shape[0]
    w2d = numpy.zeros((np,np))
    for k in range(np):
        w2d[k,k] = w[k]

    if nfock > 2:
        # nfock = 3 terms: S3 and U13
        Sn[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0]))
        U1n[2] = numpy.zeros((w.shape[0],w.shape[0],w.shape[0], nv, no))
        
        Sn[1] += 0.3333333333333333*einsum('Kia,IJKai->IJ', g.ov, U1nold[2])
        Sn[1] += 0.3333333333333333*einsum('Kia,IKJai->IJ', g.ov, U1nold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,JKIai->IJ', g.ov, U1nold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,KJIai->IJ', g.ov, U1nold[2])
        Sn[1] += 0.3333333333333333*einsum('Kia,ai,IJK->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.3333333333333333*einsum('Kia,ai,IKJ->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,ai,JKI->IJ', g.ov, T1old, Snold[2])
        Sn[1] += 0.16666666666666666*einsum('Kia,ai,KJI->IJ', g.ov, T1old, Snold[2])
        
        Sn[2] += 0.3333333333333333*einsum('IL,JKL->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('IL,JLK->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('IL,KLJ->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('IL,LKJ->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('JL,IKL->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('JL,ILK->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('JL,KLI->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('JL,LKI->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('KL,IJL->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('KL,ILJ->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('KL,JLI->IJK', w2d, Snold[2])
        Sn[2] += 0.1666666666666666*einsum('KL,LJI->IJK', w2d, Snold[2])
        Sn[2] += 0.3333333333333333*einsum('ia,IJKai->IJK', F.ov, U1nold[2])
        Sn[2] += 0.3333333333333333*einsum('ia,IKJai->IJK', F.ov, U1nold[2])
        Sn[2] += 0.1666666666666666*einsum('ia,JKIai->IJK', F.ov, U1nold[2])
        Sn[2] += 0.1666666666666666*einsum('ia,KJIai->IJK', F.ov, U1nold[2])
        Sn[2] += 1.0*einsum('Iia,JKai->IJK', g.ov, U1nold[1])
        Sn[2] += 1.0*einsum('Jia,IKai->IJK', g.ov, U1nold[1])
        Sn[2] += 1.0*einsum('Kia,IJai->IJK', g.ov, U1nold[1])
        Sn[2] += 0.3333333333333333*einsum('Lia,L,IJKai->IJK', g.ov, Snold[0], U1nold[2])
        Sn[2] += 0.3333333333333333*einsum('Lia,L,IKJai->IJK', g.ov, Snold[0], U1nold[2])
        Sn[2] += 0.1666666666666666*einsum('Lia,L,JKIai->IJK', g.ov, Snold[0], U1nold[2])
        Sn[2] += 0.1666666666666666*einsum('Lia,L,KJIai->IJK', g.ov, Snold[0], U1nold[2])
        Sn[2] += 1.0*einsum('Lia,IL,JKai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 1.0*einsum('Lia,JL,IKai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 1.0*einsum('Lia,KL,IJai->IJK', g.ov, Snold[1], U1nold[1])
        Sn[2] += 0.3333333333333333*einsum('Lia,IJL,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,IKL,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,ILJ,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,ILK,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,JKL,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.1666666666666666*einsum('Lia,JLI,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.3333333333333333*einsum('Lia,JLK,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,KLI,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,KLJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LJI,Kai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LKI,Jai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += 0.16666666666666666*einsum('Lia,LKJ,Iai->IJK', g.ov, Snold[2], U1nold[0])
        Sn[2] += -0.3333333333333333*einsum('ijab,bi,IJKaj->IJK', I.oovv, T1old, U1nold[2])
        Sn[2] += -0.3333333333333333*einsum('ijab,bi,IKJaj->IJK', I.oovv, T1old, U1nold[2])
        Sn[2] += -0.1666666666666666*einsum('ijab,bi,JKIaj->IJK', I.oovv, T1old, U1nold[2])
        Sn[2] += -0.1666666666666666*einsum('ijab,bi,KJIaj->IJK', I.oovv, T1old, U1nold[2])
        Sn[2] += -1.0*einsum('ijab,Ibi,JKaj->IJK', I.oovv, U1nold[0], U1nold[1])
        Sn[2] += -1.0*einsum('ijab,Jbi,IKaj->IJK', I.oovv, U1nold[0], U1nold[1])
        Sn[2] += -1.0*einsum('ijab,Kbi,IJaj->IJK', I.oovv, U1nold[0], U1nold[1])

        U1n[1] += 0.3333333333333333*einsum('Kai,IJK->IJai', g.vo, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kai,IKJ->IJai', g.vo, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kai,JKI->IJai', g.vo, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kai,KJI->IJai', g.vo, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,IJKaj->IJai', g.oo, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,IKJaj->IJai', g.oo, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,JKIaj->IJai', g.oo, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,KJIaj->IJai', g.oo, U1nold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,IJKbi->IJai', g.vv, U1nold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,IKJbi->IJai', g.vv, U1nold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,JKIbi->IJai', g.vv, U1nold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,KJIbi->IJai', g.vv, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,aj,IJK->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kji,aj,IKJ->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,aj,JKI->IJai', g.oo, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kji,aj,KJI->IJai', g.oo, T1old, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,bi,IJK->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.3333333333333333*einsum('Kab,bi,IKJ->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,bi,JKI->IJai', g.vv, T1old, Snold[2])
        U1n[1] += 0.16666666666666666*einsum('Kab,bi,KJI->IJai', g.vv, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,aj,IJKbi->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,aj,IKJbi->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,aj,JKIbi->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,aj,KJIbi->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,IJKaj->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,IKJaj->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,bi,JKIaj->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,bi,KJIaj->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += 0.3333333333333333*einsum('Kjb,bj,IJKai->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += 0.3333333333333333*einsum('Kjb,bj,IKJai->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += 0.16666666666666666*einsum('Kjb,bj,JKIai->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += 0.16666666666666666*einsum('Kjb,bj,KJIai->IJai', g.ov, T1old, U1nold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IJK->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,abji,IKJ->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,abji,JKI->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,abji,KJI->IJai', g.ov, T2old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IJK->IJai', g.ov, T1old, T1old, Snold[2])
        U1n[1] += -0.3333333333333333*einsum('Kjb,bi,aj,IKJ->IJai', g.ov, T1old, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,bi,aj,JKI->IJai', g.ov, T1old, T1old, Snold[2])
        U1n[1] += -0.16666666666666666*einsum('Kjb,bi,aj,KJI->IJai', g.ov, T1old, T1old, Snold[2])
        
        U1n[2] += -0.3333333333333333*einsum('ji,IJKaj->IJKai', F.oo, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('ji,IKJaj->IJKai', F.oo, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('ji,JKIaj->IJKai', F.oo, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('ji,KJIaj->IJKai', F.oo, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('ab,IJKbi->IJKai', F.vv, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('ab,IKJbi->IJKai', F.vv, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('ab,JKIbi->IJKai', F.vv, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('ab,KJIbi->IJKai', F.vv, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('IL,JKLai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('IL,JLKai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('IL,KLJai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('IL,LKJai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('JL,IKLai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('JL,ILKai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('JL,KLIai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('JL,LKIai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('KL,IJLai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('KL,ILJai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('KL,JLIai->IJKai', w2d, U1nold[2])
        U1n[2] += 0.1666666666666666*einsum('KL,LJIai->IJKai', w2d, U1nold[2])
        U1n[2] += -1.0*einsum('Iji,JKaj->IJKai', g.oo, U1nold[1])
        U1n[2] += 1.0*einsum('Iab,JKbi->IJKai', g.vv, U1nold[1])
        U1n[2] += -1.0*einsum('Jji,IKaj->IJKai', g.oo, U1nold[1])
        U1n[2] += 1.0*einsum('Jab,IKbi->IJKai', g.vv, U1nold[1])
        U1n[2] += -1.0*einsum('Kji,IJaj->IJKai', g.oo, U1nold[1])
        U1n[2] += 1.0*einsum('Kab,IJbi->IJKai', g.vv, U1nold[1])
        U1n[2] += -0.3333333333333333*einsum('jaib,IJKbj->IJKai', I.ovov, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jaib,IKJbj->IJKai', I.ovov, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jaib,JKIbj->IJKai', I.ovov, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jaib,KJIbj->IJKai', I.ovov, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jb,aj,IJKbi->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jb,aj,IKJbi->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jb,aj,JKIbi->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jb,aj,KJIbi->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jb,bi,IJKaj->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jb,bi,IKJaj->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jb,bi,JKIaj->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jb,bi,KJIaj->IJKai', F.ov, T1old, U1nold[2])
        U1n[2] += -1.0*einsum('jb,Iaj,JKbi->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jb,Ibi,JKaj->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jb,Jaj,IKbi->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jb,Jbi,IKaj->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jb,Kaj,IJbi->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jb,Kbi,IJaj->IJKai', F.ov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ijb,aj,JKbi->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Ijb,bi,JKaj->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Ijb,Jaj,Kbi->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ijb,Jbi,Kaj->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Jjb,aj,IKbi->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Jjb,bi,IKaj->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Jjb,Iaj,Kbi->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Jjb,Ibi,Kaj->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Kjb,aj,IJbi->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Kjb,bi,IJaj->IJKai', g.ov, T1old, U1nold[1])
        U1n[2] += -1.0*einsum('Kjb,Iaj,Jbi->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Kjb,Ibi,Jaj->IJKai', g.ov, U1nold[0], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,L,IJKaj->IJKai', g.oo, Snold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Lji,L,IKJaj->IJKai', g.oo, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Lji,L,JKIaj->IJKai', g.oo, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Lji,L,KJIaj->IJKai', g.oo, Snold[0], U1nold[2])
        U1n[2] += -1.0*einsum('Lji,IL,JKaj->IJKai', g.oo, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Lji,JL,IKaj->IJKai', g.oo, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Lji,KL,IJaj->IJKai', g.oo, Snold[1], U1nold[1])
        U1n[2] += -0.3333333333333333*einsum('Lji,IJL,Kaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,IKL,Jaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,ILJ,Kaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,ILK,Jaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,JKL,Iaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,JLI,Kaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Lji,JLK,Iaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,KLI,Jaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,KLJ,Iaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,LJI,Kaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,LKI,Jaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Lji,LKJ,Iaj->IJKai', g.oo, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,L,IJKbi->IJKai', g.vv, Snold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Lab,L,IKJbi->IJKai', g.vv, Snold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Lab,L,JKIbi->IJKai', g.vv, Snold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Lab,L,KJIbi->IJKai', g.vv, Snold[0], U1nold[2])
        U1n[2] += 1.0*einsum('Lab,IL,JKbi->IJKai', g.vv, Snold[1], U1nold[1])
        U1n[2] += 1.0*einsum('Lab,JL,IKbi->IJKai', g.vv, Snold[1], U1nold[1])
        U1n[2] += 1.0*einsum('Lab,KL,IJbi->IJKai', g.vv, Snold[1], U1nold[1])
        U1n[2] += 0.3333333333333333*einsum('Lab,IJL,Kbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,IKL,Jbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,ILJ,Kbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,ILK,Jbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,JKL,Ibi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,JLI,Kbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.3333333333333333*einsum('Lab,JLK,Ibi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,KLI,Jbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,KLJ,Ibi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,LJI,Kbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,LKI,Jbi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += 0.16666666666666666*einsum('Lab,LKJ,Ibi->IJKai', g.vv, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Iaj,JKLbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Iaj,JLKbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Iaj,KLJbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Iaj,LKJbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Ibi,JKLaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Ibi,JLKaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Ibi,KLJaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Ibi,LKJaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Ibj,JKLai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Ibj,JLKai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Ibj,KLJai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Ibj,LKJai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Jaj,IKLbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Jaj,ILKbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Jaj,KLIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Jaj,LKIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Jbi,IKLaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Jbi,ILKaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Jbi,KLIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Jbi,LKIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Jbj,IKLai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Jbj,ILKai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Jbj,KLIai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Jbj,LKIai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Kaj,IJLbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Kaj,ILJbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Kaj,JLIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Kaj,LJIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Kbi,IJLaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Kbi,ILJaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Kbi,JLIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Kbi,LJIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Kbj,IJLai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Kbj,ILJai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Kbj,JLIai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Kbj,LJIai->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Lai,IJKbj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('Ljb,Lai,IKJbj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Lai,JKIbj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('Ljb,Lai,KJIbj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Laj,IJKbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Laj,IKJbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Laj,JKIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Laj,KJIbi->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Lbi,IJKaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,Lbi,IKJaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Lbi,JKIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,Lbi,KJIaj->IJKai', g.ov, U1nold[0], U1nold[2])
        U1n[2] += -1.0*einsum('Ljb,IJaj,KLbi->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,IJbi,KLaj->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += 1.0*einsum('Ljb,IJbj,KLai->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,IKaj,JLbi->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,IKbi,JLaj->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += 1.0*einsum('Ljb,IKbj,JLai->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += 1.0*einsum('Ljb,ILai,JKbj->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,ILaj,JKbi->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,ILbi,JKaj->IJKai', g.ov, U1nold[1], U1nold[1])
        U1n[2] += -0.3333333333333333*einsum('jkib,aj,IJKbk->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jkib,aj,IKJbk->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkib,aj,JKIbk->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkib,aj,KJIbk->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('jkib,bj,IJKak->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('jkib,bj,IKJak->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkib,bj,JKIak->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkib,bj,KJIak->IJKai', I.ooov, T1old, U1nold[2])
        U1n[2] += -1.0*einsum('jkib,Iaj,JKbk->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkib,Ibj,JKak->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkib,Jaj,IKbk->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkib,Jbj,IKak->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkib,Kaj,IJbk->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkib,Kbj,IJak->IJKai', I.ooov, U1nold[0], U1nold[1])
        U1n[2] += 0.3333333333333333*einsum('jabc,ci,IJKbj->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('jabc,ci,IKJbj->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jabc,ci,JKIbj->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jabc,ci,KJIbj->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jabc,cj,IJKbi->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jabc,cj,IKJbi->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jabc,cj,JKIbi->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jabc,cj,KJIbi->IJKai', I.ovvv, T1old, U1nold[2])
        U1n[2] += 1.0*einsum('jabc,Ici,JKbj->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jabc,Icj,JKbi->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jabc,Jci,IKbj->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jabc,Jcj,IKbi->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jabc,Kci,IJbj->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jabc,Kcj,IJbi->IJKai', I.ovvv, U1nold[0], U1nold[1])
        U1n[2] += 0.3333333333333333*einsum('jkbc,acji,IJKbk->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('jkbc,acji,IKJbk->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,acji,JKIbk->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,acji,KJIbk->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,ackj,IJKbi->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,ackj,IKJbi->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.08333333333333333*einsum('jkbc,ackj,JKIbi->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.08333333333333333*einsum('jkbc,ackj,KJIbi->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,cbji,IJKak->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,cbji,IKJak->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.08333333333333333*einsum('jkbc,cbji,JKIak->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += 0.08333333333333333*einsum('jkbc,cbji,KJIak->IJKai', I.oovv, T2old, U1nold[2])
        U1n[2] += -1.0*einsum('Ljb,L,Iaj,JKbi->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,L,Ibi,JKaj->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,L,Jaj,IKbi->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,L,Jbi,IKaj->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,L,Kaj,IJbi->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,L,Kbi,IJaj->IJKai', g.ov, Snold[0], U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,IL,Jaj,Kbi->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ljb,IL,Jbi,Kaj->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ljb,JL,Iaj,Kbi->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ljb,JL,Ibi,Kaj->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ljb,KL,Iaj,Jbi->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('Ljb,KL,Ibi,Jaj->IJKai', g.ov, Snold[1], U1nold[0], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,L,IJKbi->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,L,IKJbi->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,L,JKIbi->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,L,KJIbi->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -1.0*einsum('Ljb,aj,IL,JKbi->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,aj,JL,IKbi->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,aj,KL,IJbi->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,IJL,Kbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,IKL,Jbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,ILJ,Kbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,ILK,Jbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,JKL,Ibi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,JLI,Kbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,aj,JLK,Ibi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,KLI,Jbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,KLJ,Ibi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,LJI,Kbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,LKI,Jbi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,aj,LKJ,Ibi->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,L,IJKaj->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,L,IKJaj->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,L,JKIaj->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,L,KJIaj->IJKai', g.ov, T1old, Snold[0], U1nold[2])
        U1n[2] += -1.0*einsum('Ljb,bi,IL,JKaj->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,bi,JL,IKaj->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -1.0*einsum('Ljb,bi,KL,IJaj->IJKai', g.ov, T1old, Snold[1], U1nold[1])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,IJL,Kaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,IKL,Jaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,ILJ,Kaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,ILK,Jaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,JKL,Iaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,JLI,Kaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('Ljb,bi,JLK,Iaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,KLI,Jaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,KLJ,Iaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,LJI,Kaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,LKI,Jaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.16666666666666666*einsum('Ljb,bi,LKJ,Iaj->IJKai', g.ov, T1old, Snold[2], U1nold[0])
        U1n[2] += -0.3333333333333333*einsum('jkbc,aj,ck,IJKbi->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jkbc,aj,ck,IKJbi->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkbc,aj,ck,JKIbi->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkbc,aj,ck,KJIbi->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += 1.0*einsum('jkbc,aj,Ici,JKbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,aj,Ick,JKbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,aj,Jci,IKbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,aj,Jck,IKbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,aj,Kci,IJbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,aj,Kck,IJbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 0.3333333333333333*einsum('jkbc,ci,aj,IJKbk->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += 0.3333333333333333*einsum('jkbc,ci,aj,IKJbk->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,ci,aj,JKIbk->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += 0.16666666666666666*einsum('jkbc,ci,aj,KJIbk->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jkbc,ci,bj,IJKak->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.3333333333333333*einsum('jkbc,ci,bj,IKJak->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkbc,ci,bj,JKIak->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += -0.16666666666666666*einsum('jkbc,ci,bj,KJIak->IJKai', I.oovv, T1old, T1old, U1nold[2])
        U1n[2] += 1.0*einsum('jkbc,ci,Iaj,JKbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,ci,Ibj,JKak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,ci,Jaj,IKbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,ci,Jbj,IKak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,ci,Kaj,IJbk->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += -1.0*einsum('jkbc,ci,Kbj,IJak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Iak,JKbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Ibi,JKak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Jak,IKbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Jbi,IKak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Kak,IJbi->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,cj,Kbi,IJak->IJKai', I.oovv, T1old, U1nold[0], U1nold[1])
        U1n[2] += 1.0*einsum('jkbc,Iaj,Jci,Kbk->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('jkbc,Iaj,Jck,Kbi->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
        U1n[2] += 1.0*einsum('jkbc,Ici,Jaj,Kbk->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
        U1n[2] += -1.0*einsum('jkbc,Ici,Jbj,Kak->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
        U1n[2] += 1.0*einsum('jkbc,Icj,Jak,Kbi->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
        U1n[2] += 1.0*einsum('jkbc,Icj,Jbi,Kak->IJKai', I.oovv, U1nold[0], U1nold[0], U1nold[0])
    if nfock > 3:
        # nfock = 4 terms: S4 and U14
        raise ValueError('nfock > 3 is not supported at this moment!!!')

    return T1, T2, Sn, U1n
